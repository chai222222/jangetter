{"version":3,"sources":["../../src/site/aeon.js"],"names":["AEON_CONSTANTS","timeout","top","zip1","zip2","replacer","title","pattern","value","jan","category","AeonSearch","page","selectors","length","selector","$","console","log","waitForNavigation","waitUntil","existsAll","needInputShop","type","click","waitFor","waitLoaded","keywords","goto","init","Array","prototype","concat","keyword","searchWord","apply","word","eachItemFromSearchResult","getAllJanUrls","links","link","getJan","productsCss","nextCss","$$eval","list","map","item","href","push","$eval","textContent","replceValues","replaceDef","obj","nobj","Object","keys","filter","key","forEach","reduce","acc","def","replace"],"mappings":"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","file":"aeon.js","sourcesContent":["import { map, mapSeries, every } from 'p-iteration';\n\nconst AEON_CONSTANTS = {\n  timeout: 30000,\n  top: 'https://www.aeonnetshop.com/',\n  zip1: '214',\n  zip2: '0038',\n  replacer: {\n    title: [{\n      pattern: /おうちでイオン イオンネットスーパー|: イオン本牧店/g,\n      value: '',\n    }],\n    jan: [{\n      pattern: /\\D/g,\n      value: '',\n    }],\n    category: [{\n      pattern: /\\t/g,\n      value: '',\n    }, {\n      pattern: /^\\n+/,\n      value: '',\n    }, {\n      pattern: /\\n+$/,\n      value: '',\n    }, {\n      pattern: /\\n/g,\n      value: ';',\n    }],\n  },\n};\n\nexport default class AeonSearch {\n\n  constructor(page) {\n    this.page = page;\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: AEON_CONSTANTS.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  /**\n   * 検索可能画面になるまで遷移する。\n   */\n  async init() {\n    const needInputShop = await this.existsAll('#zip1', '#zip2', '#shop_search_1');\n    if (needInputShop) {\n      await this.page.type('#zip1', AEON_CONSTANTS.zip1);\n      await this.page.type('#zip2', AEON_CONSTANTS.zip2) ;\n      this.page.click('#shop_search_1')\n      await this.page.waitFor(1000);\n      this.page.click('div.pc2015-main div.pc2015-select-menu-result a');\n      // await this.page.waitFor(10000);\n      await this.waitLoaded();\n    }\n    // const banner = await this.existsAll('#pc2015-popup-ad-banner a.pc2015-close');\n    // if (banner) {\n    //   await this.page.click('#pc2015-popup-ad-banner a.pc2015-close');\n    // }\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async janSearch(...keywords) {\n    console.log('*** janSearch ***');\n    await this.page.goto(AEON_CONSTANTS.top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    return await Array.prototype.concat.apply([], await map(keywords, async keyword => await this.searchWord(keyword)));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log('*** searchWord ***');\n    await this.page.type('#keyword', word);\n    await this.page.click('input[name=search]');\n    await this.waitLoaded();\n    return await this.eachItemFromSearchResult();\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。　\n   */\n  async eachItemFromSearchResult() {\n    console.log('*** eachItemFromSearchResult ***');\n    const links = await this.getAllJanUrls();\n    console.log(links);\n    return await mapSeries(links, async link => {\n      await this.page.goto(link, {waitUntil: 'networkidle2'});\n      return await this.getJan();\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    let page = 1;\n    const productsCss = 'ul.pc2015-item-list-selectable li > a:first-child';\n    const nextCss = 'div.pc2015-item-list-header a[rel=next]';\n    const links = await this.page.$$eval(productsCss, list => list.map(item => item.href));\n    while (await this.existsAll(nextCss)) { // →ボタンがある\n      console.log(`page ${++page}`);\n      await this.page.click(nextCss);\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsCss, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n  /**\n   * 商品ページからjan情報をかえします。\n   */\n  async getJan() {\n    console.log('*** getJan ***');\n    return this.replceValues(AEON_CONSTANTS.replacer, {\n      jan: await this.page.$eval('div.pc2015-item-other', item => item.textContent),\n      category: await this.page.$eval('div.pc2015-main-block-body', item => item.textContent),\n      title: await this.page.$eval('title', item => item.textContent),\n    });\n  }\n\n  /**\n   * jan, title, categoryの値を定義にそって置き換えを行います。\n   */\n  replceValues(replaceDef, obj) {\n    const nobj = { ...obj };\n    Object.keys(replaceDef).filter(key => key in nobj)\n      .forEach(key => nobj[key] = replaceDef[key].reduce((acc, def) => {\n        acc = acc.replace(def.pattern, def.value);\n        return acc;\n      }, nobj[key]));\n    return nobj;\n  }\n}\n"]}