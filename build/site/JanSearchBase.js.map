{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["JanSearchBase","outputDir","page","errors","timeout","selectors","length","selector","$","console","log","waitForNavigation","waitUntil","errs","push","join","replaceDef","obj","nobj","Object","keys","filter","key","forEach","reduce","acc","def","replace","pattern","value","keywords","goto","getSrcConfig","top","init","keyword","searchWord","word","config","outputFile","prefix","writer","WriterCreator","createCsvWriter","type","searchPageSelectors","searchText","click","searchButton","waitLoaded","eachItemFromSearchResult","close","getAllJanUrls","links","link","getJan","jan","write","addErr","result","scrollToBottom","getAllJanUrlsScrollToBottom","nextLink","getAllJanUrlsPageTransition","productsSel","productsLink","nextSel","$$eval","list","map","item","href","existsAll","Constants","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","replacer","productPageSelectors","getPageText","replceValues","url","category","title","$eval","textContent"],"mappings":"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","file":"JanSearchBase.js","sourcesContent":["import stream from 'stream';\nimport { forEachSeries, map, mapSeries, every, reduce } from 'p-iteration';\nimport WriterCreator from '../util/WriterCreator';\nimport Constants from '../constants';\n\nexport default class JanSearchBase {\n\n  constructor(outputDir, page, errors) {\n    this.outputDir = outputDir;\n    this.page = page;\n    this.errors = errors;\n    this.timeout = 30000;\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  /**\n   * jan, title, categoryの値を定義にそって置き換えを行います。\n   */\n  replceValues(replaceDef, obj) {\n    const nobj = { ...obj };\n    Object.keys(replaceDef).filter(key => key in nobj)\n      .forEach(key => nobj[key] = replaceDef[key].reduce((acc, def) => {\n        acc = acc.replace(def.pattern, def.value);\n        return acc;\n      }, nobj[key]));\n    return nobj;\n  }\n\n  async init() {\n  }\n\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    console.log('*** janSearch ***');\n    await this.page.goto(this.getSrcConfig().top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.getSrcConfig();\n    const outputFile = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}.csv`;\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.eachItemFromSearchResult();\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。　\n   */\n  async eachItemFromSearchResult() {\n    console.log('*** eachItemFromSearchResult ***');\n    const links = await this.getAllJanUrls();\n    console.log(links);\n    const result = await mapSeries(links, async link => {\n      try {\n        await this.page.goto(link, {waitUntil: 'networkidle2'});\n        const jan = await this.getJan();\n        this.writer.write(jan);\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n        return null;\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.getSrcConfig();\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    const nextSel = this.getSrcConfig().searchPageSelectors.nextLink;\n    const links = await this.page.$$eval(productsSel, list => list.map(item => item.href));\n    while (await this.existsAll(nextSel)) { // →ボタンがある\n      console.log(`page ${++page}`);\n      await this.page.click(nextSel);\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsSel, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n\n  /**\n   * 商品ページからjan情報をかえします。\n   */\n  async getJan() {\n    console.log('*** getJan ***');\n    try {\n      return this.replceValues(this.getSrcConfig().replacer, await reduce(Object.keys(this.getSrcConfig().productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {}));\n    } catch (e) {\n      const url = await this.page.url();\n      this.addErr('JANがページから取得できませんでした', url);\n      return { jan: '', category: '', title: '' };\n    }\n  }\n\n  async getPageText(key) {\n    console.log(this.getSrcConfig().productPageSelectors[key]);\n    return await this.page.$eval(this.getSrcConfig().productPageSelectors[key], item => item.textContent);\n  }\n}\n"]}