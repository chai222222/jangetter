{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["JanSearchBase","constructor","args","Object","assign","timeout","Constants","replacer","Replacer","getSrcConfig","_","get","imageInfo","existsAll","selectors","length","selector","page","$","xselectLink","startsWith","$x","$$","xselectClick","console","log","link","click","waitLoaded","waitForNavigation","waitUntil","e","addErr","errs","errors","push","join","init","setNewReader","search","keywords","config","prefix","goto","top","keyword","searchWord","word","waitForSelector","searchPageSelectors","searchText","name","outputDir","replace","outputFile","options","image","fs","existsSync","mkdirSync","writer","WriterCreator","createCsvWriter","type","searchButton","cushion","eachItemFromSearchResult","close","isEmpty","title","writeFileSync","JSON","stringify","tmpl","__dirname","tmplBody","readFileSync","encoding","res","Mustache","render","dir","hasDupLinks","getAllJanUrls","links","Array","from","Set","filterJanUrl","skipCheerio","result","idx","jan","getJanByCheerioHttpcli","undefined","getJan","replacedJan","replaceValues","test","getImage","write","scrollToBottom","getAllJanUrlsScrollToBottom","nextLink","getAllJanUrlsPageTransition","onlyCurrentPage","getAllJanUrlsOnlyCurrentPage","productsSel","productsLink","$$eval","list","map","item","href","nextSel","nexts","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","url","keys","productPageSelectors","acc","key","getPageText","rows","imgs","productPageImageSelectors","Error","row","toPairs","imageSrc","node","querySelector","src","cheerioClient","fetch","then","err","body","reduce","txt","text","sel","targets","getProperty","jsonValue","REPLACERS","toHarfWidth","pattern","value","s","String","fromCharCode","charCodeAt","toHarfWidthAlnum","toHarfWidthSpace","trim","toOneSpace","toOneLine"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport fs from 'fs';\nimport { forEachSeries, map, mapSeries, every, reduce } from 'p-iteration';\nimport cheerioClient from 'cheerio-httpcli';\nimport Mustache from 'mustache';\n\nimport WriterCreator from '../util/WriterCreator';\nimport imageDownload from '../util/ImageDownload';\nimport Replacer from '../util/Replacer';\nimport Constants from '../constants';\n\nexport default class JanSearchBase {\n\n  constructor(args) {\n    Object.assign(this, args);\n    // this.outputDir = outputDir;\n    // this.page = page;\n    // this.errors = errors;\n    // this.rc = rc;\n    this.timeout = Constants.timeout;\n    this.replacer = new Replacer(this.getSrcConfig().replacer, _.get(this, 'rc.replacer'));\n    this.imageInfo = {};\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * セレクタの要素を複数取得します。スラッシュ始まりの場合、XPath形式とみなします。\n   * @param {string} selector\n   * @return {Array<Promise>} 選択した要素\n   */\n  async xselectLink(selector) {\n    return selector.startsWith('/')\n      ? await this.page.$x(selector)\n      : await this.page.$$(selector);\n  }\n\n  async xselectClick(selector) {\n    if (selector) {\n      console.log(`*** xselectClick ${selector} ***`);\n      const link = await this.xselectLink(selector);\n      if (link.length > 0) {\n        console.log(`*** xselectClick ${selector} click`);\n        await link[0].click();\n        await this.waitLoaded();\n      }\n    }\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  async init() {\n  }\n\n  /**\n   * 検索設定定義を返す。\n   * @return {Object} 検索設定定義\n   * @property {String} prefix 出力プリフィックス\n   * @property {String} top アクセス先頭ページ\n   * @property {String} searchPageSelectors.searchText 検索文字列セレクタ\n   * @property {String} searchPageSelectors.searchButton 検索ボタンセレクタ\n   * @property {String} searchPageSelectors.nextLink 次へリンクセレクタ。XmlPathも設定可能\n   * @property {String} searchPageSelectors.productsLink 商品ページリンクセレクタ\n   * @property {String|Object} productPageSelectors.{カラム} データ取得セレクタ。\n   *           オブジェクトの場合には、selにセレクタ、methodに取得メソッドを指定する。\n   * @property {Array<Object>} replacer.{カラム} データ変換定義。patternに正規表現、valueに置き換え後の文字列。\n   */\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    const config = this.getSrcConfig();\n    console.log(`*** janSearch[${config.prefix}] ***`);\n    await this.page.goto(config.top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    // await this.page.screenshot( { path: './top.png' });\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.getSrcConfig();\n    await this.page.waitForSelector(config.searchPageSelectors.searchText);\n    const name = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}`;\n    const outputFile = `${name}.csv`;\n    if (this.options.image && !fs.existsSync(name)) {\n      console.log(`mkdir ${name}`);\n      fs.mkdirSync(name);\n    }\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.xselectClick(config.searchPageSelectors.cushion); // 検索結果がすぐに出ない画面の場合、リンクをクリックする\n    await this.eachItemFromSearchResult(name);\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n    if (!_.isEmpty(this.imageInfo)) {\n      this.imageInfo.title = word;\n      fs.writeFileSync(`${name}/data.json`, JSON.stringify(this.imageInfo, null, 2));\n      const tmpl = `${__dirname}/../../tmpl/template.html`;\n      const tmplBody = fs.readFileSync(tmpl, {encoding: \"utf-8\"});\n      const res = Mustache.render(tmplBody, this.imageInfo);\n      fs.writeFileSync(`${name}/index.html`, res, 'utf-8');\n    }\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。\n   */\n  async eachItemFromSearchResult(dir) {\n    console.log('*** eachItemFromSearchResult ***');\n    const hasDupLinks = await this.getAllJanUrls();\n    const links = Array.from(new Set(this.filterJanUrl(hasDupLinks)));\n    console.log('** LINKS', links);\n    let skipCheerio = false;\n    const result = await mapSeries(links, async (link, idx) => {\n      try {\n        console.log(`PRODUCTS[${idx+1}/${links.length}]`);\n        let jan;\n        if (this.options['enable-cheerio-httpcli'] && !skipCheerio) {\n          jan = await this.getJanByCheerioHttpcli(link);\n          skipCheerio = jan === undefined;\n        }\n        if (!jan) jan = await this.getJan(link);\n        if (!jan) return;\n        const replacedJan = this.replacer.replaceValues(jan);\n        if (typeof replacedJan.jan !== 'string' || !replacedJan.jan || /\\D/.test(`${replacedJan.jan}`)) {\n          this.addErr('JANが数字のみになっていません', link);\n          return;\n        }\n        await this.getImage(replacedJan, dir);\n       this.writer.write(replacedJan);\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n        return;\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.getSrcConfig();\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    } else if (config.searchPageSelectors.onlyCurrentPage) {\n      return this.getAllJanUrlsOnlyCurrentPage();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  /**\n   * 商品ページをカレントページないからのみ取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsOnlyCurrentPage() {\n    console.log('*** getAllJanUrlsOnlyCurrentPage ***');\n    let page = 1;\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  /**\n   * 商品ページを次ページボタンの遷移で取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    const nextSel = this.getSrcConfig().searchPageSelectors.nextLink;\n    const links = await this.page.$$eval(productsSel, list => list.map(item => item.href));\n    let nexts;\n    while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n      console.log(`PAGE ${++page}`);\n      await nexts[0].click();\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsSel, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n\n  /**\n   * 商品ページをカレントページを下に移動してAjaxで画面を更新し最後までスクロールして取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n  /**\n   * 商品ページからjan情報をかえします。\n   */\n  async getJan(url) {\n    console.log('*** getJan ***');\n    await this.page.goto(url, {waitUntil: 'networkidle2'});\n    try {\n      const result =  await reduce(Object.keys(this.getSrcConfig().productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {});\n      return result;\n    } catch (e) {\n      console.log(e);\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    }\n  }\n\n  async getImage(jan, dir) {\n    if (!dir || !this.options.image) return;\n    const rows = this.imageInfo.rows || (this.imageInfo.rows = []);\n    const imgs = this.getSrcConfig().productPageImageSelectors;\n    if (!imgs) throw new Error('Not defined productPageImageSelectors!');\n    const row = {...jan};\n    await forEachSeries(_.toPairs(imgs), async ([key, selector]) => {\n      const imageSrc = await this.page.evaluate((selector) => {\n        const node = document.querySelector(selector);\n        // img.src or a tag\n        return node.src || node.href;\n      }, selector);\n      if (imageSrc) {\n        row[key] = await imageDownload(jan.title, imageSrc, `${dir}/${jan.jan}_${key}`);\n      } else {\n        console.log(`Couldn't get image src ${imageSrc}.`);\n      }\n    });\n    rows.push(row);\n  }\n\n  async getJanByCheerioHttpcli(url) {\n    console.log('*** getJanByCheerioHttpcli ***');\n    return await cheerioClient.fetch(url).then(({err, $, res, body}) => {\n      return Object.keys(this.getSrcConfig().productPageSelectors).reduce((acc, key) => {\n        const txt = $(this.getSrcConfig().productPageSelectors[key]).text();\n        if (!acc  || !txt) {\n          console.log('getJanByCheerioHttpcli failed');\n          return undefined;\n        }\n        acc[key] = txt.replace(/[\\s　]+/, ' ').replace(/[\\r\\n]/g, '');\n        return acc;\n      }, {});\n    }).catch(e => {\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    });\n  }\n\n  /**\n   * プロダクトページから productPageSelectors に定義されているテキストを取得します。\n   * @param {String} key データ取得キー\n   * @return {String} 取得できたテキスト\n   */\n  async getPageText(key) {\n    const sel = this.getSrcConfig().productPageSelectors[key];\n    let text = '';\n    try {\n      const targets = await this.xselectLink(sel);\n      if (targets.length > 0) {\n        text = await (await targets[0].getProperty('textContent')).jsonValue();\n      }\n      return text;\n    } finally {\n      if (this.options['debug-pagetext']) {\n        console.log(`getPageText[${key}][${sel}][${text}]`);\n      }\n    }\n  }\n\n  filterJanUrl(links) {\n    return links;\n  }\n}\n\n/** 共通リプレーサ定義 */\nexport const REPLACERS = {\n  toHarfWidth: {\n    pattern: /[！-～]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthAlnum: {\n    pattern: /[Ａ-Ｚａ-ｚ０-９]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthSpace: {\n    pattern: /　+/g,\n    value: ' ',\n  },\n  trim: [ { pattern: /^\\s+/, value: '' },\n          { pattern: /\\s+$/, value: '' } ],\n  toOneSpace: {\n    pattern: /\\s\\s+/g,\n    value: ' ',\n  },\n  toOneLine: {\n    pattern: /\\r?\\n/g,\n    value: ' ',\n  }\n}\n"],"file":"JanSearchBase.js"}