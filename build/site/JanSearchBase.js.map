{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["JanSearchBase","page","errors","timeout","selectors","length","selector","$","console","log","waitForNavigation","waitUntil","errs","push","join","replaceDef","obj","nobj","Object","keys","filter","key","forEach","reduce","acc","def","replace","pattern","value","keywords","goto","getSrcConfig","top","init","Array","prototype","concat","keyword","searchWord","apply","word","type","searchPageSelectors","searchText","click","searchButton","waitLoaded","eachItemFromSearchResult","getAllJanUrls","links","link","getJan","addErr","result","r","productsSel","productsLink","nextSel","nextLink","$$eval","list","map","item","href","existsAll","replacer","getPageJan","getPageCategory","getPageTitle","jan","category","title","replceValues","url","$eval","productPageSelectors","textContent"],"mappings":"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","file":"JanSearchBase.js","sourcesContent":["import { map, mapSeries, every } from 'p-iteration';\n\nexport default class JanSearchBase {\n\n  constructor(page, errors) {\n    this.page = page;\n    this.errors = errors;\n    this.timeout = 30000;\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  /**\n   * jan, title, categoryの値を定義にそって置き換えを行います。\n   */\n  replceValues(replaceDef, obj) {\n    const nobj = { ...obj };\n    Object.keys(replaceDef).filter(key => key in nobj)\n      .forEach(key => nobj[key] = replaceDef[key].reduce((acc, def) => {\n        acc = acc.replace(def.pattern, def.value);\n        return acc;\n      }, nobj[key]));\n    return nobj;\n  }\n\n  async init() {\n  }\n\n  getSrcConfig() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    console.log('*** janSearch ***');\n    await this.page.goto(this.getSrcConfig().top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    return Array.prototype.concat.apply([], await map(keywords, async keyword => await this.searchWord(keyword)));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log('*** searchWord ***');\n    await this.page.type(this.getSrcConfig().searchPageSelectors.searchText, word);\n    await this.page.click(this.getSrcConfig().searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    return await this.eachItemFromSearchResult();\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。　\n   */\n  async eachItemFromSearchResult() {\n    console.log('*** eachItemFromSearchResult ***');\n    const links = await this.getAllJanUrls();\n    console.log(links);\n    const result = await mapSeries(links, async link => {\n      try {\n        await this.page.goto(link, {waitUntil: 'networkidle2'});\n        return await this.getJan();\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n        return null;\n      }\n    });\n    return result.filter(r => r !== null);\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    let page = 1;\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    const nextSel = this.getSrcConfig().searchPageSelectors.nextLink;\n    const links = await this.page.$$eval(productsSel, list => list.map(item => item.href));\n    while (await this.existsAll(nextSel)) { // →ボタンがある\n      console.log(`page ${++page}`);\n      await this.page.click(nextSel);\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsSel, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n\n  /**\n   * 商品ページからjan情報をかえします。\n   */\n  async getJan() {\n    console.log('*** getJan ***');\n    try {\n      return this.replceValues(this.getSrcConfig().replacer, {\n        jan: await this.getPageJan(),\n        category: await this.getPageCategory(),\n        title: await this.getPageTitle(),\n      });\n    } catch (e) {\n      const url = await this.page.url();\n      this.addErr('JANがページから取得できませんでした', url);\n      return { jan: '', category: '', title: '' };\n    }\n  }\n\n  async getPageJan() {\n    return await this.page.$eval(this.getSrcConfig().productPageSelectors.jan, item => item.textContent);\n  }\n  async getPageCategory() {\n    return await this.page.$eval(this.getSrcConfig().productPageSelectors.category, item => item.textContent);\n  }\n  async getPageTitle() {\n    return await this.page.$eval(this.getSrcConfig().productPageSelectors.title, item => item.textContent);\n  }\n}\n"]}