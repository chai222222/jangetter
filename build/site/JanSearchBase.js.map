{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["JanSearchBase","args","Object","assign","timeout","Constants","selectors","length","selector","page","$","startsWith","$x","$$","console","log","xselectLink","link","click","waitLoaded","waitForNavigation","waitUntil","errs","errors","push","join","replaceDef","obj","nobj","keys","filter","key","forEach","reduce","acc","def","replace","pattern","value","keywords","goto","getSrcConfig","top","init","keyword","searchWord","word","config","outputFile","outputDir","prefix","writer","WriterCreator","createCsvWriter","type","searchPageSelectors","searchText","searchButton","xselectClick","cushion","eachItemFromSearchResult","close","getAllJanUrls","links","skipCheerio","idx","jan","options","getJanByCheerioHttpcli","undefined","getJan","addErr","write","replceValues","replacer","result","scrollToBottom","getAllJanUrlsScrollToBottom","nextLink","getAllJanUrlsPageTransition","productsSel","productsLink","nextSel","$$eval","list","map","item","href","nexts","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","url","productPageSelectors","getPageText","cheerioClient","fetch","then","err","res","body","txt","text","sel","$eval","textContent","REPLACERS","toHarfWidthAlnum","s","String","fromCharCode","charCodeAt","toHarfWidthSpace"],"mappings":";;;;;;;;;;;AAAA;;;;AACA;;AACA;;;;AAEA;;;;AACA;;;;;;;;;;;;IAEqBA,a;AAEnB,yBAAYC,IAAZ,EAAkB;AAAA;;AAChBC,WAAOC,MAAP,CAAc,IAAd,EAAoBF,IAApB;AACA;AACA;AACA;AACA,SAAKG,OAAL,GAAeC,oBAAUD,OAAzB;AACD;;AAED;;;;;;;;;;;;0CAImBE,S;AAAAA,mB;;;;;;;kDACVA,UAAUC,MAAV,GAAmB,CAAnB,IAAwB,uBAAMD,SAAN;AAAA,sFAAiB,iBAAOE,QAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAA2B,MAAKC,IAAL,CAAUC,CAAV,CAAYF,QAAZ,CAA3B;;AAAA;AAAA;AAAA,6EAAsD,IAAtD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAjB;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;AAGjC;;;;;;;;;4FAKkBA,Q;;;;;qBACTA,SAASG,UAAT,CAAoB,GAApB,C;;;;;;uBACG,KAAKF,IAAL,CAAUG,EAAV,CAAaJ,QAAb,C;;;;;;;;;uBACA,KAAKC,IAAL,CAAUI,EAAV,CAAaL,QAAb,C;;;;;;;;;;;;;;;;;;;;;;;;;4FAGOA,Q;;;;;;qBACbA,Q;;;;;AACFM,wBAAQC,GAAR,uBAAgCP,QAAhC;;uBACmB,KAAKQ,WAAL,CAAiBR,QAAjB,C;;;AAAbS,oB;;sBACFA,KAAKV,MAAL,GAAc,C;;;;;AAChBO,wBAAQC,GAAR,uBAAgCP,QAAhC;;uBACMS,KAAK,CAAL,EAAQC,KAAR,E;;;;uBACA,KAAKC,UAAL,E;;;;;;;;;;;;;;;;;AAKZ;;;;;;;;;;;;AAIEL,wBAAQC,GAAR,CAAY,oBAAZ;;;uBAEQ,KAAKN,IAAL,CAAUW,iBAAV,CAA4B,EAAEhB,SAAS,KAAKA,OAAhB,EAAyBiB,WAAW,kBAApC,EAA5B,C;;;;;;;;;;;;;;;;;;;;;;;;;;6BAMM;AAAA,yCAANC,IAAM;AAANA,YAAM;AAAA;;AACd,WAAKC,MAAL,CAAYC,IAAZ,CAAiBF,KAAKG,IAAL,CAAU,GAAV,CAAjB;AACD;;AAED;;;;;;iCAGaC,U,EAAYC,G,EAAK;AAC5B,UAAMC,oBAAYD,GAAZ,CAAN;AACAzB,aAAO2B,IAAP,CAAYH,UAAZ,EAAwBI,MAAxB,CAA+B;AAAA,eAAOC,OAAOH,IAAd;AAAA,OAA/B,EACGI,OADH,CACW;AAAA,eAAOJ,KAAKG,GAAL,IAAYL,WAAWK,GAAX,EAAgBE,MAAhB,CAAuB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC/DD,gBAAMA,IAAIE,OAAJ,CAAYD,IAAIE,OAAhB,EAAyBF,IAAIG,KAA7B,CAAN;AACA,iBAAOJ,GAAP;AACD,SAH2B,EAGzBN,KAAKG,GAAL,CAHyB,CAAnB;AAAA,OADX;AAKA,aAAOH,IAAP;AACD;;;;;;;;;;;;;;;;;;;;;;;;mCAKc,CACd;;;mCAEc,CACd;;AAED;;;;;;;;;;2CAGgBW,Q;AAAAA,kB;;;;;;;AACdzB,wBAAQC,GAAR,CAAY,mBAAZ;;uBACM,KAAKN,IAAL,CAAU+B,IAAV,CAAe,KAAKC,YAAL,GAAoBC,GAAnC,EAAwC,EAACrB,WAAW,cAAZ,EAAxC,C;;;;uBACA,KAAKsB,IAAL,E;;;;uBACA,+BAAcJ,QAAd;AAAA,sFAAwB,kBAAMK,OAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAAuB,OAAKC,UAAL,CAAgBD,OAAhB,CAAvB;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAxB;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;AAGR;;;;;;;;4FAIiBE,I;;;;;;AACfhC,wBAAQC,GAAR,iBAA0B+B,IAA1B;AACMC,sB,GAAS,KAAKN,YAAL,E;AACTO,0B,GAAgB,KAAKC,S,SAAaF,OAAOG,M,SAAUJ,KAAKV,OAAL,CAAa,KAAb,EAAoB,GAApB,C;;AACzD,qBAAKe,MAAL,GAAcC,wBAAcC,eAAd,CAA8BL,UAA9B,CAAd;;uBACM,KAAKvC,IAAL,CAAU6C,IAAV,CAAeP,OAAOQ,mBAAP,CAA2BC,UAA1C,EAAsDV,IAAtD,C;;;;uBACA,KAAKrC,IAAL,CAAUS,KAAV,CAAgB6B,OAAOQ,mBAAP,CAA2BE,YAA3C,C;;;;uBACA,KAAKtC,UAAL,E;;;;uBACA,KAAKuC,YAAL,CAAkBX,OAAOQ,mBAAP,CAA2BI,OAA7C,C;;;;uBACA,KAAKC,wBAAL,E;;;AACN,qBAAKT,MAAL,CAAYU,KAAZ;AACA/C,wBAAQC,GAAR,oBAA6BiC,UAA7B;;;;;;;;;;;;;;;;;AAGF;;;;;;;;;;;;;;;AAIElC,wBAAQC,GAAR,CAAY,kCAAZ;;uBACoB,KAAK+C,aAAL,E;;;AAAdC,qB;;AACNjD,wBAAQC,GAAR,CAAY,UAAZ,EAAwBgD,KAAxB;AACIC,2B,GAAc,K;;uBACG,2BAAUD,KAAV;AAAA,uFAAiB,mBAAO9C,IAAP,EAAagD,GAAb;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAElCnD,oCAAQC,GAAR,gBAAwBkD,MAAI,CAA5B,UAAiCF,MAAMxD,MAAvC;AACI2D,+BAH8B;;AAAA,kCAI9B,OAAKC,OAAL,CAAa,wBAAb,KAA0C,CAACH,WAJb;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAKpB,OAAKI,sBAAL,CAA4BnD,IAA5B,CALoB;;AAAA;AAKhCiD,+BALgC;;AAMhCF,0CAAcE,QAAQG,SAAtB;;AANgC;AAAA,gCAQ7BH,GAR6B;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAQZ,OAAKI,MAAL,CAAYrD,IAAZ,CARY;;AAAA;AAQxBiD,+BARwB;;AAAA;AAAA,gCAS7BA,GAT6B;AAAA;AAAA;AAAA;;AAUhC,mCAAKK,MAAL,CAAY,kBAAZ,EAAgCtD,IAAhC;AAVgC;;AAAA;AAanC,mCAAKkC,MAAL,CAAYqB,KAAZ,CAAkB,OAAKC,YAAL,CAAkB,OAAKhC,YAAL,GAAoBiC,QAAtC,EAAgDR,GAAhD,CAAlB;AAbmC;AAAA;;AAAA;AAAA;AAAA;;AAelC,mCAAKK,MAAL,CAAY,kBAAZ,EAAgCtD,IAAhC;AAfkC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAjB;;AAAA;AAAA;AAAA;AAAA,oB;;;AAAf0D,sB;;;;;;;;;;;;;;;;;AAqBR;;;;;;;;;;;;;AAIE7D,wBAAQC,GAAR,CAAY,uBAAZ;AACMgC,sB,GAAS,KAAKN,YAAL,E;;qBACXM,OAAOQ,mBAAP,CAA2BqB,c;;;;;mDACtB,KAAKC,2BAAL,E;;;qBACE9B,OAAOQ,mBAAP,CAA2BuB,Q;;;;;mDAC7B,KAAKC,2BAAL,E;;;AAET,qBAAKR,MAAL,CAAY,uBAAZ;mDACO,E;;;;;;;;;;;;;;;;;;;;;;;;;AAIPzD,wBAAQC,GAAR,CAAY,qCAAZ;AACIN,oB,GAAO,C;AACLuE,2B,GAAc,KAAKvC,YAAL,GAAoBc,mBAApB,CAAwC0B,Y;AACtDC,uB,GAAU,KAAKzC,YAAL,GAAoBc,mBAApB,CAAwCuB,Q;;uBACpC,KAAKrE,IAAL,CAAU0E,MAAV,CAAiBH,WAAjB,EAA8B;AAAA,yBAAQI,KAAKC,GAAL,CAAS;AAAA,2BAAQC,KAAKC,IAAb;AAAA,mBAAT,CAAR;AAAA,iBAA9B,C;;;AAAdxB,qB;AACFyB,qB;;;;uBACkB,KAAKxE,WAAL,CAAiBkE,OAAjB,C;;;iCAAdM,K,oBAAyCjF,M;;sCAAS,C;;;;;AAAK;AAC7DO,wBAAQC,GAAR,WAAoB,EAAEN,IAAtB;;uBACM+E,MAAM,CAAN,EAAStE,KAAT,E;;;;uBACA,KAAKC,UAAL,E;;;gCACN4C,K,CAAMvC,I;gCAANuC,K;;;uBAAqB,KAAKtD,IAAL,CAAU0E,MAAV,CAAiBH,WAAjB,EAA8B;AAAA,yBAAQI,KAAKC,GAAL,CAAS;AAAA,2BAAQC,KAAKC,IAAb;AAAA,mBAAT,CAAR;AAAA,iBAA9B,C;;;;;;;;;;;;mDAEhBxB,K;;;;;;;;;;;;;;;;;;;;;;;;;AAIPjD,wBAAQC,GAAR,CAAY,qCAAZ;;uBACM,KAAK6D,cAAL,CAAoB,KAAKnE,IAAzB,EAA+BJ,oBAAUoF,QAAV,CAAmBC,MAAlD,C;;;AACAV,2B,GAAc,KAAKvC,YAAL,GAAoBc,mBAApB,CAAwC0B,Y;;uBAC/C,KAAKxE,IAAL,CAAU0E,MAAV,CAAiBH,WAAjB,EAA8B;AAAA,yBAAQI,KAAKC,GAAL,CAAS;AAAA,2BAAQC,KAAKC,IAAb;AAAA,mBAAT,CAAR;AAAA,iBAA9B,C;;;;;;;;;;;;;;;;;;;;;;8FAGM9E,I,EAAMkF,c;;;;;;AACnBC,+B,GAAkB,SAAlBA,eAAkB,GAAM;AAC5B,yBAAOC,QAAQC,OAAR,CAAgBC,SAASC,eAAT,CAAyBC,YAAzC,CAAP;AAA+D,iB;;;uBAExCxF,KAAKyF,QAAL,CAAcN,eAAd,C;;;AAArBK,4B;AACAE,+B,GAAkB,C;AAClBC,4B,GAAe,C;;;sBAEZD,kBAAkBF,Y;;;;;AACvBG,gCAAgB,CAAhB;AACMC,4B,GAAeD,eAAeT,c;;uBAC9BlF,KAAKyF,QAAL,CAAc,UAAUI,QAAV,EAAoB;AACtC,yBAAOT,QAAQC,OAAR,CAAgBS,OAAOD,QAAP,CAAgB,CAAhB,EAAmBA,QAAnB,CAAhB,CAAP;AACD,iBAFK,EAEHD,YAFG,C;;;;uBAGA5F,KAAKW,iBAAL,CAAuB,EAACC,WAAW,cAAZ,EAA4BjB,SAAS,IAArC,EAAvB,EACKoG,KADL,CACW;AAAA,yBAAK1F,QAAQC,GAAR,CAAY,2CAAZ,CAAL;AAAA,iBADX,C;;;;AAGNoF,kCAAkBE,YAAlB;AACAvF,wBAAQC,GAAR,oBAA6BqF,YAA7B;AACAtF,wBAAQC,GAAR,uBAAgCoF,eAAhC;;AAEA;;uBACqB1F,KAAKyF,QAAL,CAAcN,eAAd,C;;;AAArBK,4B;;AACAnF,wBAAQC,GAAR,mBAA4BkF,YAA5B;;;;;;;;;;;;;;;;;;;AAKJ;;;;;;;8FAGaQ,G;;;;;;;AACX3F,wBAAQC,GAAR,CAAY,gBAAZ;;uBACM,KAAKN,IAAL,CAAU+B,IAAV,CAAeiE,GAAf,EAAoB,EAACpF,WAAW,cAAZ,EAApB,C;;;;;uBAES,wBAAOnB,OAAO2B,IAAP,CAAY,KAAKY,YAAL,GAAoBiE,oBAAhC,CAAP;AAAA,uFAA8D,mBAAOxE,GAAP,EAAYH,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACxD,OAAK4E,WAAL,CAAiB5E,GAAjB,CADwD;;AAAA;AACzEG,gCAAIH,GAAJ,CADyE;AAAA,+DAElEG,GAFkE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAA9D;;AAAA;AAAA;AAAA;AAAA,qBAGV,EAHU,C;;;;;;;;;AAKb,qBAAKqC,MAAL,CAAY,qBAAZ,EAAmCkC,GAAnC;mDACOpC,S;;;;;;;;;;;;;;;;;;;8FAIkBoC,G;;;;;;;AAC3B3F,wBAAQC,GAAR,CAAY,gCAAZ;;uBACa6F,yBAAcC,KAAd,CAAoBJ,GAApB,EAAyBK,IAAzB,CAA8B,kBAAyB;AAAA,sBAAvBC,GAAuB,UAAvBA,GAAuB;AAAA,sBAAlBrG,CAAkB,UAAlBA,CAAkB;AAAA,sBAAfsG,GAAe,UAAfA,GAAe;AAAA,sBAAVC,IAAU,UAAVA,IAAU;;AAClE,yBAAO/G,OAAO2B,IAAP,CAAY,OAAKY,YAAL,GAAoBiE,oBAAhC,EAAsDzE,MAAtD,CAA6D,UAACC,GAAD,EAAMH,GAAN,EAAc;AAChF,wBAAMmF,MAAMxG,EAAE,OAAK+B,YAAL,GAAoBiE,oBAApB,CAAyC3E,GAAzC,CAAF,EAAiDoF,IAAjD,EAAZ;AACA,wBAAI,CAACjF,GAAD,IAAS,CAACgF,GAAd,EAAmB;AACjBpG,8BAAQC,GAAR,CAAY,+BAAZ;AACA,6BAAOsD,SAAP;AACD;AACDnC,wBAAIH,GAAJ,IAAWmF,IAAI9E,OAAJ,CAAY,QAAZ,EAAsB,GAAtB,EAA2BA,OAA3B,CAAmC,SAAnC,EAA8C,EAA9C,CAAX;AACA,2BAAOF,GAAP;AACD,mBARM,EAQJ,EARI,CAAP;AASD,iBAVY,EAUVsE,KAVU,CAUJ,aAAK;AACZ,yBAAOnC,SAAP;AACD,iBAZY,C;;;;;;;;;;;;;;;;;;;;;;8FAgBGtC,G;;;;;;AACVqF,mB,GAAM,KAAK3E,YAAL,GAAoBiE,oBAApB,CAAyC3E,GAAzC,C;AACRoF,oB,GAAO,E;;;uBAEW,KAAK1G,IAAL,CAAU4G,KAAV,CAAgBD,GAAhB,EAAqB;AAAA,yBAAQ9B,KAAKgC,WAAb;AAAA,iBAArB,C;;;mDAAbH,I;;;;;AAEP,oBAAI,KAAKhD,OAAL,CAAa,gBAAb,CAAJ,EAAoC;AAClCrD,0BAAQC,GAAR,kBAA2BgB,GAA3B,UAAmCqF,GAAnC,UAA2CD,IAA3C;AACD;;;;;;;;;;;;;;;;;;;;;;AAKP;;;kBA1PqBnH,a;AA2Pd,IAAMuH,gCAAY;AACvBC,oBAAkB;AAChBnF,aAAS,cADO;AAEhBC,WAAO,eAACmF,CAAD,EAAO;AACZ,aAAOC,OAAOC,YAAP,CAAoBF,EAAEG,UAAF,CAAa,CAAb,IAAkB,KAAtC,CAAP;AACD;AAJe,GADK;AAOvBC,oBAAkB;AAChBxF,aAAS,KADO;AAEhBC,WAAO;AAFS;AAPK,CAAlB","file":"JanSearchBase.js","sourcesContent":["import stream from 'stream';\nimport { forEachSeries, map, mapSeries, every, reduce } from 'p-iteration';\nimport cheerioClient from 'cheerio-httpcli';\n\nimport WriterCreator from '../util/WriterCreator';\nimport Constants from '../constants';\n\nexport default class JanSearchBase {\n\n  constructor(args) {\n    Object.assign(this, args);\n    // this.outputDir = outputDir;\n    // this.page = page;\n    // this.errors = errors;\n    this.timeout = Constants.timeout;\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * セレクタの要素を複数取得します。スラッシュ始まりの場合、XPath形式とみなします。\n   * @param {string} selector\n   * @return {Array<Promise>} 選択した要素\n   */\n  async xselectLink(selector) {\n    return selector.startsWith('/')\n      ? await this.page.$x(selector)\n      : await this.page.$$(selector);\n  }\n\n  async xselectClick(selector) {\n    if (selector) {\n      console.log(`*** xselectClick ${selector} ***`);\n      const link = await this.xselectLink(selector);\n      if (link.length > 0) {\n        console.log(`*** xselectClick ${selector} click`);\n        await link[0].click();\n        await this.waitLoaded();\n      }\n    }\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  /**\n   * jan, title, categoryの値を定義にそって置き換えを行います。\n   */\n  replceValues(replaceDef, obj) {\n    const nobj = { ...obj };\n    Object.keys(replaceDef).filter(key => key in nobj)\n      .forEach(key => nobj[key] = replaceDef[key].reduce((acc, def) => {\n        acc = acc.replace(def.pattern, def.value);\n        return acc;\n      }, nobj[key]));\n    return nobj;\n  }\n\n  async init() {\n  }\n\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    console.log('*** janSearch ***');\n    await this.page.goto(this.getSrcConfig().top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.getSrcConfig();\n    const outputFile = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}.csv`;\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.xselectClick(config.searchPageSelectors.cushion);\n    await this.eachItemFromSearchResult();\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。　\n   */\n  async eachItemFromSearchResult() {\n    console.log('*** eachItemFromSearchResult ***');\n    const links = await this.getAllJanUrls();\n    console.log('** LINKS', links);\n    let skipCheerio = false;\n    const result = await mapSeries(links, async (link, idx) => {\n      try {\n        console.log(`PRODUCTS[${idx+1}/${links.length}]`);\n        let jan;\n        if (this.options['enable-cheerio-httpcli'] && !skipCheerio) {\n          jan = await this.getJanByCheerioHttpcli(link);\n          skipCheerio = jan === undefined;\n        }\n        if (!jan) jan = await this.getJan(link);\n        if (!jan) {\n          this.addErr('商品ページへ移動できませんでした', link);\n          return;\n        }\n       this.writer.write(this.replceValues(this.getSrcConfig().replacer, jan));\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n        return;\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.getSrcConfig();\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    const nextSel = this.getSrcConfig().searchPageSelectors.nextLink;\n    const links = await this.page.$$eval(productsSel, list => list.map(item => item.href));\n    let nexts;\n    while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n      console.log(`PAGE ${++page}`);\n      await nexts[0].click();\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsSel, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n\n  /**\n   * 商品ページからjan情報をかえします。\n   */\n  async getJan(url) {\n    console.log('*** getJan ***');\n    await this.page.goto(url, {waitUntil: 'networkidle2'});\n    try {\n      return await reduce(Object.keys(this.getSrcConfig().productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {});\n    } catch (e) {\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    }\n  }\n\n  async getJanByCheerioHttpcli(url) {\n    console.log('*** getJanByCheerioHttpcli ***');\n    return await cheerioClient.fetch(url).then(({err, $, res, body}) => {\n      return Object.keys(this.getSrcConfig().productPageSelectors).reduce((acc, key) => {\n        const txt = $(this.getSrcConfig().productPageSelectors[key]).text();\n        if (!acc  || !txt) {\n          console.log('getJanByCheerioHttpcli failed');\n          return undefined;\n        }\n        acc[key] = txt.replace(/[\\s　]+/, ' ').replace(/[\\r\\n]/g, '');\n        return acc;\n      }, {});\n    }).catch(e => {\n      return undefined;\n    });\n  }\n\n\n  async getPageText(key) {\n    const sel = this.getSrcConfig().productPageSelectors[key];\n    let text = '';\n    try {\n      return text = await this.page.$eval(sel, item => item.textContent);\n    } finally {\n      if (this.options['debug-pagetext']) {\n        console.log(`getPageText[${key}][${sel}][${text}]`);\n      }\n    }\n  }\n}\n\n/** 共通リプレーサ定義 */\nexport const REPLACERS = {\n  toHarfWidthAlnum: {\n    pattern: /[Ａ-Ｚａ-ｚ０-９]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 65248);\n    },\n  },\n  toHarfWidthSpace: {\n    pattern: /　+/g,\n    value: ' ',\n  }\n}\n"]}