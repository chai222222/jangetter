{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["DEFAULT_PRODUCT_TEXTS_CHECK_DEF","jan","regexp","option","error","JanSearchBase","constructor","args","Object","assign","srcConfig","getSrcConfig","timeout","Constants","replacer","Replacer","_","get","imageInfo","existsAll","selectors","length","selector","page","$","xselectLink","startsWith","$x","$$","xselectClick","console","log","link","click","waitLoaded","xselectText","targets","getProperty","jsonValue","waitForNavigation","waitUntil","e","addErr","errs","errors","push","join","init","setNewReader","search","keywords","config","prefix","goto","top","keyword","searchWord","word","waitForSelector","searchPageSelectors","searchText","name","outputDir","replace","outputFile","options","image","fs","existsSync","mkdirSync","writer","WriterCreator","createCsvWriter","type","searchButton","cushion","eachItemFromSearchResult","close","isEmpty","title","writeFileSync","JSON","stringify","tmpl","__dirname","tmplBody","readFileSync","encoding","res","Mustache","render","dir","hasDupLinks","getAllJanUrls","links","Array","from","Set","filterJanUrl","skipCheerio","result","idx","getProductTextsByCheerioHttpcli","undefined","getProductTexts","replacedJan","replaceValues","nullables","checkers","allOk","keys","productPageSelectors","filter","key","isString","every","chk","reg","RegExp","test","getImages","write","scrollToBottom","getAllJanUrlsScrollToBottom","onlyCurrentPage","getAllJanUrlsOnlyCurrentPage","nextLink","getAllJanUrlsPageTransition","nextSel","nexts","waitFor","productsSel","productsLink","$$eval","list","map","item","href","waitSel","productsPageWaiter","pageCntSel","productsPageCounter","waitAndGetProductsLink","pageObj","getPageCntInfo","isSame","waitProductsPage","selectArgs","isArray","lastPageObj","pageSel","curPageObj","pageText","eq","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","url","acc","getPageText","rows","downloader","suffix","imgs","productPageImageSelectors","Error","row","toPairs","imageSrc","sel","node","querySelector","src","saveImage","ext","substr","lastIndexOf","query","suf","saveFile","viewSource","buffer","axios","responseType","Buffer","data","lastSlash","cheerioClient","fetch","then","err","body","reduce","txt","text","isObject","paths","texts","arr","path","target","attr","getAttribute","v","separator","REPLACERS","toHarfWidth","pattern","value","s","String","fromCharCode","charCodeAt","toHarfWidthAlnum","toHarfWidthSpace","trim","toOneSpace","toOneLine"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport axios from 'axios';\nimport fs from 'fs';\nimport { forEachSeries, mapSeries, every, reduce } from 'p-iteration';\nimport cheerioClient from 'cheerio-httpcli';\nimport Mustache from 'mustache';\n\nimport WriterCreator from '../util/WriterCreator';\nimport Replacer from '../util/Replacer';\nimport Constants from '../constants';\n\nconst DEFAULT_PRODUCT_TEXTS_CHECK_DEF = {\n  jan: {\n    regexp: '^\\\\d+$',\n    option: '',\n    error: 'JANが数字のみになっていません',\n  },\n};\n\nexport default class JanSearchBase {\n  constructor(args) {\n    Object.assign(this, args);\n    // this.outputDir = outputDir;\n    // this.page = page;\n    // this.errors = errors;\n    // this.rc = rc;\n    this.srcConfig = this.getSrcConfig();\n    this.timeout = Constants.timeout;\n    this.replacer = new Replacer(this.srcConfig.replacer, _.get(this, 'rc.replacer'));\n    this.imageInfo = {};\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * セレクタの要素を複数取得します。スラッシュ始まりの場合、XPath形式とみなします。\n   * @param {string} selector\n   * @return {Array<Promise>} 選択した要素\n   */\n  async xselectLink(selector) {\n    return selector.startsWith('/')\n      ? await this.page.$x(selector)\n      : await this.page.$$(selector);\n  }\n\n  async xselectClick(selector) {\n    if (selector) {\n      console.log(`*** xselectClick ${selector} ***`);\n      const link = await this.xselectLink(selector);\n      if (link.length > 0) {\n        console.log(`*** xselectClick ${selector} click`);\n        await link[0].click();\n        await this.waitLoaded();\n      }\n    }\n  }\n\n  async xselectText(selector) {\n    const targets = await this.xselectLink(selector);\n    if (targets.length > 0) {\n      return await (await targets[0].getProperty('textContent')).jsonValue();\n    }\n    return '';\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  async init() {\n  }\n\n  /**\n   * 検索設定定義を返す。\n   * @return {Object} 検索設定定義\n   * @property {String} prefix 出力プリフィックス\n   * @property {String} top アクセス先頭ページ\n   * @property {String} searchPageSelectors.searchText 検索文字列セレクタ\n   * @property {String} searchPageSelectors.searchButton 検索ボタンセレクタ\n   * @property {String} searchPageSelectors.nextLink 次へリンクセレクタ。XmlPathも設定可能\n   * @property {String} searchPageSelectors.productsLink 商品ページリンクセレクタ\n   * @property {String|Object} productPageSelectors.{カラム} データ取得セレクタ。\n   *           オブジェクトの場合には、selにセレクタ、methodに取得メソッドを指定する。\n   * @property {Array<Object>} replacer.{カラム} データ変換定義。patternに正規表現、valueに置き換え後の文字列。\n   */\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    const config = this.srcConfig;\n    console.log(`*** janSearch[${config.prefix}] ***`);\n    await this.page.goto(config.top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    // await this.page.screenshot( { path: './top.png' });\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.srcConfig;\n    await this.page.waitForSelector(config.searchPageSelectors.searchText);\n    const name = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}`;\n    const outputFile = `${name}.csv`;\n    if (this.options.image && !fs.existsSync(name)) {\n      console.log(`mkdir ${name}`);\n      fs.mkdirSync(name);\n    }\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.xselectClick(config.searchPageSelectors.cushion); // 検索結果がすぐに出ない画面の場合、リンクをクリックする\n    await this.eachItemFromSearchResult(name);\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n    if (!_.isEmpty(this.imageInfo)) {\n      this.imageInfo.title = word;\n      fs.writeFileSync(`${name}/data.json`, JSON.stringify(this.imageInfo, null, 2));\n      const tmpl = `${__dirname}/../../tmpl/template.html`;\n      const tmplBody = fs.readFileSync(tmpl, {encoding: \"utf-8\"});\n      const res = Mustache.render(tmplBody, this.imageInfo);\n      fs.writeFileSync(`${name}/index.html`, res, 'utf-8');\n    }\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。\n   */\n  async eachItemFromSearchResult(dir) {\n    console.log('*** eachItemFromSearchResult ***');\n    const hasDupLinks = await this.getAllJanUrls();\n    const links = Array.from(new Set(this.filterJanUrl(hasDupLinks)));\n    console.log('** LINKS', links);\n    let skipCheerio = false;\n    const result = await mapSeries(links, async (link, idx) => {\n      try {\n        console.log(`PRODUCTS[${idx + 1}/${links.length}]`);\n        let jan;\n        if (this.options['enable-cheerio-httpcli'] && !skipCheerio) {\n          jan = await this.getProductTextsByCheerioHttpcli(link);\n          skipCheerio = jan === undefined;\n        }\n        if (!jan) jan = await this.getProductTexts(link);\n        if (!jan) return;\n        const replacedJan = this.replacer.replaceValues(jan);\n        const nullables = Object.assign({}, this.srcConfig.nullables || {});\n        const checkers = Object.assign({}, DEFAULT_PRODUCT_TEXTS_CHECK_DEF, this.srcConfig.checkers || {});\n        // 必須項目のチェック\n        const allOk = Object.keys(this.srcConfig.productPageSelectors)\n          .filter((key) => !_.isString(nullables[key]))\n          .every((key) => {\n            const chk = checkers[key];\n            if (chk) {\n              const reg = new RegExp(chk.regexp, chk.option);\n              if (!reg.test(replacedJan[key])) {\n                this.addErr(chk.error, link);\n                return false;\n              }\n            } else if (!_.isString(replacedJan[key]) || replacedJan[key].length === 0) {\n              this.addErr(`キー[${key}] の値が取得できず空文字列になっています。`, link);\n              return false;\n            }\n            return true;\n          });\n        if (!allOk) return;\n        await this.getImages(replacedJan, dir);\n        this.writer.write(replacedJan);\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.srcConfig;\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.onlyCurrentPage) {\n      return this.getAllJanUrlsOnlyCurrentPage();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  /**\n   * 商品ページをカレントページないからのみ取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsOnlyCurrentPage() {\n    console.log('*** getAllJanUrlsOnlyCurrentPage ***');\n    const nextSel = this.srcConfig.searchPageSelectors.nextLink;\n    if (nextSel) {\n      let page = 1;\n      let nexts;\n      // カレントページのボタンをクリックし対象を増やす\n      while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n        console.log(`PAGE ${++page}`);\n        await nexts[0].click();\n        await this.waitLoaded();\n        await this.page.waitFor(20000);\n      }\n    }\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  /**\n   * 商品ページを次ページボタンの遷移で取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    const nextSel = this.srcConfig.searchPageSelectors.nextLink;\n    const waitSel = this.srcConfig.searchPageSelectors.productsPageWaiter; // ページ遷移後、セレクタが出るまで待つ\n    const pageCntSel = this.srcConfig.searchPageSelectors.productsPageCounter; // ページ遷移結果チェックを行う\n    const links = await this.waitAndGetProductsLink(waitSel, productsSel);\n    let pageObj = await this.getPageCntInfo({}, pageCntSel);\n    let nexts;\n    while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n      await nexts[0].click();\n      await this.waitLoaded();\n      pageObj = await this.getPageCntInfo(pageObj, pageCntSel);\n      if (pageObj.isSame) {\n        break; // ページ遷移結果チェックがある場合、ページ遷移が行われなかった場合にそこで終わりとする\n      }\n      console.log(`PAGE ${++page}`);\n      links.push(... await this.waitAndGetProductsLink(waitSel, productsSel));\n    }\n    return links;\n  }\n\n  async waitAndGetProductsLink(waitSel, productsSel) {\n    await this.waitProductsPage(waitSel);\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async waitProductsPage(selectArgs) {\n    if (_.isArray(selectArgs)) {\n      console.log('*** waitProductsPage ***');\n      await this.page.waitForSelector(...selectArgs);\n    }\n  }\n\n  async getPageCntInfo(lastPageObj, pageSel) {\n    const curPageObj = {};\n    if (pageSel) {\n      curPageObj.pageText = await this.xselectText(pageSel);\n      curPageObj.isSame = _.eq(lastPageObj.pageText, curPageObj.pageText);\n      console.log('*** getPageCntInfo: page check ***', curPageObj);\n    } else {\n      curPageObj.isSame = false;\n    }\n    return curPageObj;\n  }\n\n  /**\n   * 商品ページをカレントページを下に移動してAjaxで画面を更新し最後までスクロールして取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n  /**\n   * 商品ページからproductPageSelectorsに定義された情報を取得します。\n   */\n  async getProductTexts(url) {\n    console.log('*** getProductTexts ***');\n    await this.page.goto(url, {waitUntil: 'networkidle2'});\n    try {\n      const result =  await reduce(Object.keys(this.srcConfig.productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {});\n      return result;\n    } catch (e) {\n      console.log(e);\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    }\n  }\n\n  // TODO: puppeteerダウンロードモード追加\n  // https://www.webtomoblg.net/web/puppeteer-practice/#toc2\n  async getImages(jan, dir) {\n    if (!dir || !this.options.image) return;\n    const rows = this.imageInfo.rows || (this.imageInfo.rows = []);\n    const downloader = _.get(this.srcConfig, 'productPageImages.downloader');\n    const suffix = _.get(this.srcConfig, 'productPageImages.suffix');\n    const imgs = this.srcConfig.productPageImageSelectors;\n    if (!imgs) throw new Error('Not defined productPageImageSelectors!');\n    const row = {...jan};\n    await forEachSeries(_.toPairs(imgs), async ([key, selector]) => {\n      const imageSrc = await this.page.evaluate((sel) => {\n        const node = document.querySelector(sel);\n        // img.src or a tag\n        return node.src || node.href;\n      }, selector);\n      if (imageSrc) {\n        const name = await this.saveImage(dir, jan, key, downloader, imageSrc, suffix);\n        if (name) {\n          row[key] = name;\n          return;\n        }\n      }\n      console.log(`Couldn't get image src ${imageSrc}.`);\n    });\n    rows.push(row);\n  }\n\n  async saveImage(dir, jan, key, downloader, imageSrc, suffix) {\n    const ext = imageSrc.substr(imageSrc.lastIndexOf('.'));\n    const query = ext.lastIndexOf('?');\n    const suf = suffix || (query < 0 ? ext : ext.substr(0, query));\n    const saveFile = `${dir}/${jan.jan}_${key}${suf}`; // 保存ファイルフルパス\n    try {\n      if (downloader === 'puppeteer') {\n        const viewSource = await this.page.goto(imageSrc);\n        fs.writeFileSync(saveFile, await viewSource.buffer(), 'binary');\n      } else {\n        const res = await axios.get(imageSrc, { responseType: 'arraybuffer' });\n        fs.writeFileSync(saveFile, new Buffer.from(res.data), 'binary');\n      }\n      const lastSlash = saveFile.lastIndexOf('/');\n      return lastSlash >= 0 ? saveFile.substr(lastSlash + 1) : lastSlash;\n    } catch (error) {\n      console.log(`[Image] image [${jan.title}] Couldn't get from ${imageSrc}. ${error}`);\n    }\n    return '';\n  }\n\n  async getProductTextsByCheerioHttpcli(url) {\n    console.log('*** getProductTextsByCheerioHttpcli ***');\n    return await cheerioClient.fetch(url).then(({err, $, res, body}) => {\n      return Object.keys(this.srcConfig.productPageSelectors).reduce((acc, key) => {\n        const txt = $(this.srcConfig.productPageSelectors[key]).text();\n        if (!acc  || !txt) {\n          console.log('getJanByCheerioHttpcli failed');\n          return undefined;\n        }\n        acc[key] = txt.replace(/[\\s　]+/, ' ').replace(/[\\r\\n]/g, '');\n        return acc;\n      }, {});\n    }).catch(e => {\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    });\n  }\n\n  /**\n   * プロダクトページから productPageSelectors に定義されているテキストを取得します。\n   * 定義がテキストの場合には、単純セレクタで単純文字列の取得を行います。\n   * 定義がオブジェクトの場合には、path がセレクタで、複数ヒット・配列定義が可能。\n   * また、attr がある場合にはnodeの属性から値を取得します。\n   * @param {String} key データ取得キー\n   * @return {String} 取得できたテキスト\n   */\n  async getPageText(key) {\n    const sel = this.srcConfig.productPageSelectors[key];\n    let text = '';\n    try {\n      if (_.isString(sel)) {\n        if (sel === 'url') { // url文字列の場合、url値を使う\n          return this.page.url();\n        }\n        return this.xselectText(sel);\n      }\n      if (_.isObject(sel)) {\n        const paths = _.isArray(sel.selector) ? sel.selector : [sel.selector];\n        const texts = await reduce(paths, async (arr, path) => {\n          const targets = await this.xselectLink(path);\n          return [ ...arr, ...await mapSeries(targets, async (target) => (\n            await (sel.attr\n              ? await this.page.evaluate((node, attr) => node.getAttribute(attr), target, sel.attr)\n              : await (await target.getProperty('textContent')).jsonValue()\n          )))];\n          return arr;\n        }, []);\n        return texts.filter(v => !!v).join(sel.separator || '・');\n      }\n      this.addErr('productPageSelectorsの定義が不正です', key);\n      return undefined;\n    } finally {\n      if (this.options['debug-pagetext']) {\n        console.log(`getPageText[${key}][${sel}][${text}]`);\n      }\n    }\n  }\n\n  filterJanUrl(links) {\n    return links;\n  }\n}\n\n/** 共通リプレーサ定義 */\nexport const REPLACERS = {\n  toHarfWidth: {\n    pattern: /[！-～]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthAlnum: {\n    pattern: /[Ａ-Ｚａ-ｚ０-９]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthSpace: {\n    pattern: /　+/g,\n    value: ' ',\n  },\n  trim: [ { pattern: /^\\s+/, value: '' },\n          { pattern: /\\s+$/, value: '' } ],\n  toOneSpace: {\n    pattern: /\\s\\s+/g,\n    value: ' ',\n  },\n  toOneLine: {\n    pattern: /\\r?\\n/g,\n    value: ' ',\n  },\n};\n"],"file":"JanSearchBase.js"}