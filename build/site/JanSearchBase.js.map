{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["DEFAULT_PRODUCT_TEXTS_CHECK_DEF","jan","regexp","option","error","JanSearchBase","constructor","args","Object","assign","srcConfig","getSrcConfig","timeout","Constants","imageInfo","updateSiteInformation","replacer","Replacer","_","get","isString","siteKey","isObject","custom","rc","site","toPairs","forEach","path","value","set","Error","existsAll","selectors","length","selector","page","$","xselectLink","startsWith","$x","$$","xselectClick","console","log","link","click","waitLoaded","xselectText","targets","getProperty","jsonValue","waitForNavigation","waitUntil","e","addErr","errs","errors","push","join","init","setNewReader","search","keywords","config","prefix","goto","top","keyword","searchWord","word","waitForSelector","searchPageSelectors","searchText","name","outputDir","replace","outputFile","options","image","fs","existsSync","mkdirSync","writer","WriterCreator","createCsvWriter","type","searchButton","cushion","eachItemFromSearchResult","close","isEmpty","title","writeFileSync","JSON","stringify","tmpl","__dirname","tmplBody","readFileSync","encoding","res","Mustache","render","dir","hasDupLinks","getAllJanUrls","links","Array","from","Set","filterJanUrl","skipCheerio","result","idx","getProductTextsByCheerioHttpcli","undefined","getProductTexts","replacedJan","replaceValues","skipInfo","isArray","productPageSkipSelectors","sel","nullables","checkers","allOk","keys","productPageSelectors","filter","key","every","chk","reg","RegExp","test","getImages","write","scrollToBottom","getAllJanUrlsScrollToBottom","onlyCurrentPage","getAllJanUrlsOnlyCurrentPage","nextLink","getAllJanUrlsPageTransition","nextSel","nexts","waitFor","productsSel","productsLink","$$eval","list","map","item","href","waitSel","productsPageWaiter","pageCntSel","productsPageCounter","waitAndGetProductsLink","pageObj","getPageCntInfo","isSame","waitProductsPage","selectArgs","lastPageObj","pageSel","curPageObj","pageText","eq","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","url","acc","getPageText","rows","downloader","suffix","imgs","productPageImageSelectors","row","imageSrc","node","querySelector","src","saveImage","ext","substr","lastIndexOf","query","suf","saveFile","viewSource","buffer","axios","responseType","Buffer","data","lastSlash","cheerioClient","fetch","then","err","body","reduce","txt","text","specialPageText","attribute","attr","separator","paths","texts","arr","spVal","target","getAttribute","v","REPLACERS","toHarfWidth","pattern","s","String","fromCharCode","charCodeAt","toHarfWidthAlnum","toHarfWidthSpace","trim","toOneSpace","toOneLine"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;;;AAEA,MAAMA,+BAA+B,GAAG;AACtCC,EAAAA,GAAG,EAAE;AACHC,IAAAA,MAAM,EAAE,QADL;AAEHC,IAAAA,MAAM,EAAE,EAFL;AAGHC,IAAAA,KAAK,EAAE;AAHJ;AADiC,CAAxC;;AAQe,MAAMC,aAAN,CAAoB;AACjCC,EAAAA,WAAW,CAACC,IAAD,EAAO;AAChBC,IAAAA,MAAM,CAACC,MAAP,CAAc,IAAd,EAAoBF,IAApB,EADgB,CAEhB;AACA;AACA;AACA;;AACA,SAAKG,SAAL,GAAiB,KAAKC,YAAL,EAAjB;AACA,SAAKC,OAAL,GAAeC,mBAAUD,OAAzB;AACA,SAAKE,SAAL,GAAiB,EAAjB;AACA,SAAKC,qBAAL;AACA,SAAKC,QAAL,GAAgB,IAAIC,iBAAJ,CAAa,KAAKP,SAAL,CAAeM,QAA5B,EAAsCE,gBAAEC,GAAF,CAAM,IAAN,EAAY,aAAZ,CAAtC,CAAhB;AACD;;AAEDJ,EAAAA,qBAAqB,GAAG;AACtB,QAAIG,gBAAEE,QAAF,CAAW,KAAKC,OAAhB,KAA4BH,gBAAEI,QAAF,CAAWJ,gBAAEC,GAAF,CAAM,IAAN,EAAa,WAAU,KAAKE,OAAQ,GAApC,CAAX,CAAhC,EAAqF;AACnF,YAAME,MAAM,GAAG,KAAKC,EAAL,CAAQC,IAAR,CAAa,KAAKJ,OAAlB,CAAf;;AACA,UAAIH,gBAAEI,QAAF,CAAWC,MAAX,CAAJ,EAAwB;AACtBL,wBAAEQ,OAAF,CAAUH,MAAV,EAAkBI,OAAlB,CAA0B,CAAC,CAACC,IAAD,EAAOC,KAAP,CAAD,KAAmBX,gBAAEY,GAAF,CAAM,KAAKpB,SAAX,EAAsBkB,IAAtB,EAA4BC,KAA5B,CAA7C;AACD,OAFD,MAEO;AACL,cAAM,IAAIE,KAAJ,CAAW,gBAAe,KAAKV,OAAQ,kBAAvC,CAAN;AACD;AACF;AACF;AAED;AACF;AACA;AACA;;;AACiB,QAATW,SAAS,CAAC,GAAGC,SAAJ,EAAe;AAC5B,WAAOA,SAAS,CAACC,MAAV,GAAmB,CAAnB,IAAwB,uBAAMD,SAAN,EAAiB,MAAOE,QAAP,IAAoB,CAAC,MAAM,KAAKC,IAAL,CAAUC,CAAV,CAAYF,QAAZ,CAAP,MAAkC,IAAvE,CAA/B;AACD;AAED;AACF;AACA;AACA;AACA;;;AACmB,QAAXG,WAAW,CAACH,QAAD,EAAW;AAC1B,WAAOA,QAAQ,CAACI,UAAT,CAAoB,GAApB,IACH,MAAM,KAAKH,IAAL,CAAUI,EAAV,CAAaL,QAAb,CADH,GAEH,MAAM,KAAKC,IAAL,CAAUK,EAAV,CAAaN,QAAb,CAFV;AAGD;;AAEiB,QAAZO,YAAY,CAACP,QAAD,EAAW;AAC3B,QAAIA,QAAJ,EAAc;AACZQ,MAAAA,OAAO,CAACC,GAAR,CAAa,oBAAmBT,QAAS,MAAzC;AACA,YAAMU,IAAI,GAAG,MAAM,KAAKP,WAAL,CAAiBH,QAAjB,CAAnB;;AACA,UAAIU,IAAI,CAACX,MAAL,GAAc,CAAlB,EAAqB;AACnBS,QAAAA,OAAO,CAACC,GAAR,CAAa,oBAAmBT,QAAS,QAAzC;AACA,cAAMU,IAAI,CAAC,CAAD,CAAJ,CAAQC,KAAR,EAAN;AACA,cAAM,KAAKC,UAAL,EAAN;AACD;AACF;AACF;;AAEgB,QAAXC,WAAW,CAACb,QAAD,EAAW;AAC1B,UAAMc,OAAO,GAAG,MAAM,KAAKX,WAAL,CAAiBH,QAAjB,CAAtB;;AACA,QAAIc,OAAO,CAACf,MAAR,GAAiB,CAArB,EAAwB;AACtB,aAAO,MAAM,CAAC,MAAMe,OAAO,CAAC,CAAD,CAAP,CAAWC,WAAX,CAAuB,aAAvB,CAAP,EAA8CC,SAA9C,EAAb;AACD;;AACD,WAAO,EAAP;AACD;AAED;AACF;AACA;;;AACkB,QAAVJ,UAAU,GAAG;AACjBJ,IAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ;;AACA,QAAI;AACF,YAAM,KAAKR,IAAL,CAAUgB,iBAAV,CAA4B;AAAExC,QAAAA,OAAO,EAAE,KAAKA,OAAhB;AAAyByC,QAAAA,SAAS,EAAE;AAApC,OAA5B,CAAN;AACD,KAFD,CAEE,OAAOC,CAAP,EAAU,CACV;AACD;AACF;;AAEDC,EAAAA,MAAM,CAAC,GAAGC,IAAJ,EAAU;AACd,SAAKC,MAAL,CAAYC,IAAZ,CAAiBF,IAAI,CAACG,IAAL,CAAU,GAAV,CAAjB;AACD;;AAES,QAAJC,IAAI,GAAG,CACZ;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACEjD,EAAAA,YAAY,GAAG,CACd;;AAEDkD,EAAAA,YAAY,GAAG,CACd;AAED;AACF;AACA;;;AACc,QAANC,MAAM,CAAC,GAAGC,QAAJ,EAAc;AACxB,UAAMC,MAAM,GAAG,KAAKtD,SAApB;AACAiC,IAAAA,OAAO,CAACC,GAAR,CAAa,iBAAgBoB,MAAM,CAACC,MAAO,OAA3C;AACA,UAAM,KAAK7B,IAAL,CAAU8B,IAAV,CAAeF,MAAM,CAACG,GAAtB,EAA2B;AAACd,MAAAA,SAAS,EAAE;AAAZ,KAA3B,CAAN;AACA,UAAM,KAAKO,IAAL,EAAN,CAJwB,CAIL;AACnB;;AACA,UAAM,+BAAcG,QAAd,EAAwB,MAAMK,OAAN,IAAiB,MAAM,KAAKC,UAAL,CAAgBD,OAAhB,CAA/C,CAAN;AACD;AAED;AACF;AACA;AACA;;;AACkB,QAAVC,UAAU,CAACC,IAAD,EAAO;AACrB3B,IAAAA,OAAO,CAACC,GAAR,CAAa,cAAa0B,IAAK,OAA/B;AACA,UAAMN,MAAM,GAAG,KAAKtD,SAApB;AACA,UAAM,KAAK0B,IAAL,CAAUmC,eAAV,CAA0BP,MAAM,CAACQ,mBAAP,CAA2BC,UAArD,CAAN;AACA,UAAMC,IAAI,GAAI,GAAE,KAAKC,SAAU,IAAGX,MAAM,CAACC,MAAO,IAAGK,IAAI,CAACM,OAAL,CAAa,KAAb,EAAoB,GAApB,CAAyB,EAA5E;AACA,UAAMC,UAAU,GAAI,GAAEH,IAAK,MAA3B;;AACA,QAAI,KAAKI,OAAL,CAAaC,KAAb,IAAsB,CAACC,YAAGC,UAAH,CAAcP,IAAd,CAA3B,EAAgD;AAC9C/B,MAAAA,OAAO,CAACC,GAAR,CAAa,SAAQ8B,IAAK,EAA1B;;AACAM,kBAAGE,SAAH,CAAaR,IAAb;AACD;;AACD,SAAKS,MAAL,GAAcC,uBAAcC,eAAd,CAA8BR,UAA9B,CAAd;AACA,UAAM,KAAKzC,IAAL,CAAUkD,IAAV,CAAetB,MAAM,CAACQ,mBAAP,CAA2BC,UAA1C,EAAsDH,IAAtD,CAAN;AACA,UAAM,KAAKlC,IAAL,CAAUU,KAAV,CAAgBkB,MAAM,CAACQ,mBAAP,CAA2Be,YAA3C,CAAN;AACA,UAAM,KAAKxC,UAAL,EAAN;AACA,UAAM,KAAKL,YAAL,CAAkBsB,MAAM,CAACQ,mBAAP,CAA2BgB,OAA7C,CAAN,CAdqB,CAcwC;;AAC7D,UAAM,KAAKC,wBAAL,CAA8Bf,IAA9B,CAAN;AACA,SAAKS,MAAL,CAAYO,KAAZ;AACA/C,IAAAA,OAAO,CAACC,GAAR,CAAa,iBAAgBiC,UAAW,GAAxC;;AACA,QAAI,CAAC3D,gBAAEyE,OAAF,CAAU,KAAK7E,SAAf,CAAL,EAAgC;AAC9B,WAAKA,SAAL,CAAe8E,KAAf,GAAuBtB,IAAvB;;AACAU,kBAAGa,aAAH,CAAkB,GAAEnB,IAAK,YAAzB,EAAsCoB,IAAI,CAACC,SAAL,CAAe,KAAKjF,SAApB,EAA+B,IAA/B,EAAqC,CAArC,CAAtC;;AACA,YAAMkF,IAAI,GAAI,GAAEC,SAAU,2BAA1B;;AACA,YAAMC,QAAQ,GAAGlB,YAAGmB,YAAH,CAAgBH,IAAhB,EAAsB;AAACI,QAAAA,QAAQ,EAAE;AAAX,OAAtB,CAAjB;;AACA,YAAMC,GAAG,GAAGC,kBAASC,MAAT,CAAgBL,QAAhB,EAA0B,KAAKpF,SAA/B,CAAZ;;AACAkE,kBAAGa,aAAH,CAAkB,GAAEnB,IAAK,aAAzB,EAAuC2B,GAAvC,EAA4C,OAA5C;AACD;AACF;AAED;AACF;AACA;;;AACgC,QAAxBZ,wBAAwB,CAACe,GAAD,EAAM;AAClC7D,IAAAA,OAAO,CAACC,GAAR,CAAY,kCAAZ;AACA,UAAM6D,WAAW,GAAG,MAAM,KAAKC,aAAL,EAA1B;AACA,UAAMC,KAAK,GAAGC,KAAK,CAACC,IAAN,CAAW,IAAIC,GAAJ,CAAQ,KAAKC,YAAL,CAAkBN,WAAlB,CAAR,CAAX,CAAd;AACA9D,IAAAA,OAAO,CAACC,GAAR,CAAY,UAAZ,EAAwB+D,KAAxB;AACA,QAAIK,WAAW,GAAG,KAAlB;AACA,UAAMC,MAAM,GAAG,MAAM,2BAAUN,KAAV,EAAiB,OAAO9D,IAAP,EAAaqE,GAAb,KAAqB;AACzD,UAAI;AACFvE,QAAAA,OAAO,CAACC,GAAR,CAAa,YAAWsE,GAAG,GAAG,CAAE,IAAGP,KAAK,CAACzE,MAAO,GAAhD;AACA,YAAIjC,GAAJ;;AACA,YAAI,KAAK6E,OAAL,CAAa,wBAAb,KAA0C,CAACkC,WAA/C,EAA4D;AAC1D/G,UAAAA,GAAG,GAAG,MAAM,KAAKkH,+BAAL,CAAqCtE,IAArC,CAAZ;AACAmE,UAAAA,WAAW,GAAG/G,GAAG,KAAKmH,SAAtB;AACD;;AACD,YAAI,CAACnH,GAAL,EAAUA,GAAG,GAAG,MAAM,KAAKoH,eAAL,CAAqBxE,IAArB,CAAZ;AACV,YAAI,CAAC5C,GAAL,EAAU;AACV,cAAMqH,WAAW,GAAG,KAAKtG,QAAL,CAAcuG,aAAd,CAA4BtH,GAA5B,CAApB,CATE,CAUF;;AACA,cAAMuH,QAAQ,GAAGtG,gBAAEuG,OAAF,CAAU,KAAK/G,SAAL,CAAegH,wBAAzB,IAAsD,KAAKhH,SAAL,CAAegH,wBAArE,GAAgGN,SAAjH;;AACA,YAAII,QAAJ,EAAc;AACZ;AACA,cAAI,MAAM,sBAAKA,QAAL,EAAe,MAAOG,GAAP,IAAe,CAAC,MAAM,KAAKrF,WAAL,CAAiBqF,GAAjB,CAAP,EAA8BzF,MAA9B,GAAuC,CAArE,CAAV,EAAmF;AACjFS,YAAAA,OAAO,CAACC,GAAR,CAAY,kBAAZ,EAAgCC,IAAhC;AACA;AACD;AACF;;AACD,cAAM+E,SAAS,GAAGpH,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKC,SAAL,CAAekH,SAAf,IAA4B,EAA9C,CAAlB;AACA,cAAMC,QAAQ,GAAGrH,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBT,+BAAlB,EAAmD,KAAKU,SAAL,CAAemH,QAAf,IAA2B,EAA9E,CAAjB,CApBE,CAqBF;;AACA,cAAMC,KAAK,GAAGtH,MAAM,CAACuH,IAAP,CAAY,KAAKrH,SAAL,CAAesH,oBAA3B,EACXC,MADW,CACHC,GAAD,IAAS,CAAChH,gBAAEE,QAAF,CAAWwG,SAAS,CAACM,GAAD,CAApB,CADN,EAEXC,KAFW,CAEJD,GAAD,IAAS;AACd,gBAAME,GAAG,GAAGP,QAAQ,CAACK,GAAD,CAApB;;AACA,cAAIE,GAAJ,EAAS;AACP,kBAAMC,GAAG,GAAG,IAAIC,MAAJ,CAAWF,GAAG,CAAClI,MAAf,EAAuBkI,GAAG,CAACjI,MAA3B,CAAZ;;AACA,gBAAI,CAACkI,GAAG,CAACE,IAAJ,CAASjB,WAAW,CAACY,GAAD,CAApB,CAAL,EAAiC;AAC/B,mBAAK3E,MAAL,CAAY6E,GAAG,CAAChI,KAAhB,EAAuByC,IAAvB;AACA,qBAAO,KAAP;AACD;AACF,WAND,MAMO,IAAI,CAAC3B,gBAAEE,QAAF,CAAWkG,WAAW,CAACY,GAAD,CAAtB,CAAD,IAAiCZ,WAAW,CAACY,GAAD,CAAX,CAAiBhG,MAAjB,KAA4B,CAAjE,EAAoE;AACzE,iBAAKqB,MAAL,CAAa,MAAK2E,GAAI,wBAAtB,EAA+CrF,IAA/C;AACA,mBAAO,KAAP;AACD;;AACD,iBAAO,IAAP;AACD,SAfW,CAAd;AAgBA,YAAI,CAACiF,KAAL,EAAY;AACZ,cAAM,KAAKU,SAAL,CAAelB,WAAf,EAA4Bd,GAA5B,CAAN;AACA,aAAKrB,MAAL,CAAYsD,KAAZ,CAAkBnB,WAAlB;AACD,OAzCD,CAyCE,OAAOhE,CAAP,EAAU;AACV,aAAKC,MAAL,CAAY,kBAAZ,EAAgCV,IAAhC,EAAsCS,CAAtC;AACD;AACF,KA7CoB,CAArB;AA8CD;AAED;AACF;AACA;;;AACqB,QAAboD,aAAa,GAAG;AACpB/D,IAAAA,OAAO,CAACC,GAAR,CAAY,uBAAZ;AACA,UAAMoB,MAAM,GAAG,KAAKtD,SAApB;;AACA,QAAIsD,MAAM,CAACQ,mBAAP,CAA2BkE,cAA/B,EAA+C;AAC7C,aAAO,KAAKC,2BAAL,EAAP;AACD,KAFD,MAEO,IAAI3E,MAAM,CAACQ,mBAAP,CAA2BoE,eAA/B,EAAgD;AACrD,aAAO,KAAKC,4BAAL,EAAP;AACD,KAFM,MAEA,IAAI7E,MAAM,CAACQ,mBAAP,CAA2BsE,QAA/B,EAAyC;AAC9C,aAAO,KAAKC,2BAAL,EAAP;AACD;;AACD,SAAKxF,MAAL,CAAY,uBAAZ;AACA,WAAO,EAAP;AACD;AAED;AACF;AACA;AACA;;;AACoC,QAA5BsF,4BAA4B,GAAG;AACnClG,IAAAA,OAAO,CAACC,GAAR,CAAY,sCAAZ;AACA,UAAMoG,OAAO,GAAG,KAAKtI,SAAL,CAAe8D,mBAAf,CAAmCsE,QAAnD;;AACA,QAAIE,OAAJ,EAAa;AACX,UAAI5G,IAAI,GAAG,CAAX;AACA,UAAI6G,KAAJ,CAFW,CAGX;;AACA,aAAO,CAACA,KAAK,GAAG,MAAM,KAAK3G,WAAL,CAAiB0G,OAAjB,CAAf,EAA0C9G,MAA1C,GAAmD,CAA1D,EAA6D;AAAE;AAC7DS,QAAAA,OAAO,CAACC,GAAR,CAAa,QAAO,EAAER,IAAK,EAA3B;AACA,cAAM6G,KAAK,CAAC,CAAD,CAAL,CAASnG,KAAT,EAAN;AACA,cAAM,KAAKC,UAAL,EAAN;AACA,cAAM,KAAKX,IAAL,CAAU8G,OAAV,CAAkB,KAAlB,CAAN;AACD;AACF;;AACD,UAAMC,WAAW,GAAG,KAAKzI,SAAL,CAAe8D,mBAAf,CAAmC4E,YAAvD;AACA,WAAO,MAAM,KAAKhH,IAAL,CAAUiH,MAAV,CAAiBF,WAAjB,EAA8BG,IAAI,IAAIA,IAAI,CAACC,GAAL,CAASC,IAAI,IAAIA,IAAI,CAACC,IAAtB,CAAtC,CAAb;AACD;AAED;AACF;AACA;AACA;;;AACmC,QAA3BV,2BAA2B,GAAG;AAClCpG,IAAAA,OAAO,CAACC,GAAR,CAAY,qCAAZ;AACA,QAAIR,IAAI,GAAG,CAAX;AACA,UAAM+G,WAAW,GAAG,KAAKzI,SAAL,CAAe8D,mBAAf,CAAmC4E,YAAvD;AACA,UAAMJ,OAAO,GAAG,KAAKtI,SAAL,CAAe8D,mBAAf,CAAmCsE,QAAnD;AACA,UAAMY,OAAO,GAAG,KAAKhJ,SAAL,CAAe8D,mBAAf,CAAmCmF,kBAAnD,CALkC,CAKqC;;AACvE,UAAMC,UAAU,GAAG,KAAKlJ,SAAL,CAAe8D,mBAAf,CAAmCqF,mBAAtD,CANkC,CAMyC;;AAC3E,UAAMlD,KAAK,GAAG,MAAM,KAAKmD,sBAAL,CAA4BJ,OAA5B,EAAqCP,WAArC,CAApB;AACA,QAAIY,OAAO,GAAG,MAAM,KAAKC,cAAL,CAAoB,EAApB,EAAwBJ,UAAxB,CAApB;AACA,QAAIX,KAAJ;;AACA,WAAO,CAACA,KAAK,GAAG,MAAM,KAAK3G,WAAL,CAAiB0G,OAAjB,CAAf,EAA0C9G,MAA1C,GAAmD,CAA1D,EAA6D;AAAE;AAC7D,YAAM+G,KAAK,CAAC,CAAD,CAAL,CAASnG,KAAT,EAAN;AACA,YAAM,KAAKC,UAAL,EAAN;AACAgH,MAAAA,OAAO,GAAG,MAAM,KAAKC,cAAL,CAAoBD,OAApB,EAA6BH,UAA7B,CAAhB;;AACA,UAAIG,OAAO,CAACE,MAAZ,EAAoB;AAClB,cADkB,CACX;AACR;;AACDtH,MAAAA,OAAO,CAACC,GAAR,CAAa,QAAO,EAAER,IAAK,EAA3B;AACAuE,MAAAA,KAAK,CAACjD,IAAN,CAAW,IAAI,MAAM,KAAKoG,sBAAL,CAA4BJ,OAA5B,EAAqCP,WAArC,CAAV,CAAX;AACD;;AACD,WAAOxC,KAAP;AACD;;AAE2B,QAAtBmD,sBAAsB,CAACJ,OAAD,EAAUP,WAAV,EAAuB;AACjD,UAAM,KAAKe,gBAAL,CAAsBR,OAAtB,CAAN;AACA,WAAO,MAAM,KAAKtH,IAAL,CAAUiH,MAAV,CAAiBF,WAAjB,EAA8BG,IAAI,IAAIA,IAAI,CAACC,GAAL,CAASC,IAAI,IAAIA,IAAI,CAACC,IAAtB,CAAtC,CAAb;AACD;;AAEqB,QAAhBS,gBAAgB,CAACC,UAAD,EAAa;AACjC,QAAIjJ,gBAAEuG,OAAF,CAAU0C,UAAV,CAAJ,EAA2B;AACzBxH,MAAAA,OAAO,CAACC,GAAR,CAAY,0BAAZ;AACA,YAAM,KAAKR,IAAL,CAAUmC,eAAV,CAA0B,GAAG4F,UAA7B,CAAN;AACD;AACF;;AAEmB,QAAdH,cAAc,CAACI,WAAD,EAAcC,OAAd,EAAuB;AACzC,UAAMC,UAAU,GAAG,EAAnB;;AACA,QAAID,OAAJ,EAAa;AACXC,MAAAA,UAAU,CAACC,QAAX,GAAsB,MAAM,KAAKvH,WAAL,CAAiBqH,OAAjB,CAA5B;AACAC,MAAAA,UAAU,CAACL,MAAX,GAAoB/I,gBAAEsJ,EAAF,CAAKJ,WAAW,CAACG,QAAjB,EAA2BD,UAAU,CAACC,QAAtC,CAApB;AACA5H,MAAAA,OAAO,CAACC,GAAR,CAAY,oCAAZ,EAAkD0H,UAAlD;AACD,KAJD,MAIO;AACLA,MAAAA,UAAU,CAACL,MAAX,GAAoB,KAApB;AACD;;AACD,WAAOK,UAAP;AACD;AAED;AACF;AACA;AACA;;;AACmC,QAA3B3B,2BAA2B,GAAG;AAClChG,IAAAA,OAAO,CAACC,GAAR,CAAY,qCAAZ;AACA,UAAM,KAAK8F,cAAL,CAAoB,KAAKtG,IAAzB,EAA+BvB,mBAAU4J,QAAV,CAAmBC,MAAlD,CAAN;AACA,UAAMvB,WAAW,GAAG,KAAKzI,SAAL,CAAe8D,mBAAf,CAAmC4E,YAAvD;AACA,WAAO,MAAM,KAAKhH,IAAL,CAAUiH,MAAV,CAAiBF,WAAjB,EAA8BG,IAAI,IAAIA,IAAI,CAACC,GAAL,CAASC,IAAI,IAAIA,IAAI,CAACC,IAAtB,CAAtC,CAAb;AACD;;AAEmB,QAAdf,cAAc,CAACtG,IAAD,EAAOuI,cAAP,EAAuB;AACzC,UAAMC,eAAe,GAAG,MAAM;AAC5B,aAAOC,OAAO,CAACC,OAAR,CAAgBC,QAAQ,CAACC,eAAT,CAAyBC,YAAzC,CAAP;AAA+D,KADjE;;AAGA,QAAIA,YAAY,GAAG,MAAM7I,IAAI,CAAC8I,QAAL,CAAcN,eAAd,CAAzB;AACA,QAAIO,eAAe,GAAG,CAAtB;AACA,QAAIC,YAAY,GAAG,CAAnB;;AAEA,WAAOD,eAAe,GAAGF,YAAzB,EAAuC;AACrCG,MAAAA,YAAY,IAAI,CAAhB;AACA,YAAMC,YAAY,GAAGD,YAAY,GAAGT,cAApC;AACA,YAAMvI,IAAI,CAAC8I,QAAL,CAAc,UAAUI,QAAV,EAAoB;AACtC,eAAOT,OAAO,CAACC,OAAR,CAAgBS,MAAM,CAACD,QAAP,CAAgB,CAAhB,EAAmBA,QAAnB,CAAhB,CAAP;AACD,OAFK,EAEHD,YAFG,CAAN;AAGA,YAAMjJ,IAAI,CAACgB,iBAAL,CAAuB;AAACC,QAAAA,SAAS,EAAE,cAAZ;AAA4BzC,QAAAA,OAAO,EAAE;AAArC,OAAvB,EACK4K,KADL,CACWlI,CAAC,IAAIX,OAAO,CAACC,GAAR,CAAY,2CAAZ,CADhB,CAAN;AAGAuI,MAAAA,eAAe,GAAGE,YAAlB;AACA1I,MAAAA,OAAO,CAACC,GAAR,CAAa,iBAAgBwI,YAAa,EAA1C;AACAzI,MAAAA,OAAO,CAACC,GAAR,CAAa,oBAAmBuI,eAAgB,EAAhD,EAXqC,CAarC;;AACAF,MAAAA,YAAY,GAAG,MAAM7I,IAAI,CAAC8I,QAAL,CAAcN,eAAd,CAArB;AACAjI,MAAAA,OAAO,CAACC,GAAR,CAAa,gBAAeqI,YAAa,EAAzC;AACD;AACF;AAED;AACF;AACA;;;AACuB,QAAf5D,eAAe,CAACoE,GAAD,EAAM;AACzB9I,IAAAA,OAAO,CAACC,GAAR,CAAY,yBAAZ;AACA,UAAM,KAAKR,IAAL,CAAU8B,IAAV,CAAeuH,GAAf,EAAoB;AAACpI,MAAAA,SAAS,EAAE;AAAZ,KAApB,CAAN;;AACA,QAAI;AACF,YAAM4D,MAAM,GAAI,MAAM,wBAAOzG,MAAM,CAACuH,IAAP,CAAY,KAAKrH,SAAL,CAAesH,oBAA3B,CAAP,EAAyD,OAAO0D,GAAP,EAAYxD,GAAZ,KAAoB;AACjGwD,QAAAA,GAAG,CAACxD,GAAD,CAAH,GAAW,MAAM,KAAKyD,WAAL,CAAiBzD,GAAjB,CAAjB;AACA,eAAOwD,GAAP;AACD,OAHqB,EAGnB,EAHmB,CAAtB;AAIA,aAAOzE,MAAP;AACD,KAND,CAME,OAAO3D,CAAP,EAAU;AACVX,MAAAA,OAAO,CAACC,GAAR,CAAYU,CAAZ;AACA,WAAKC,MAAL,CAAY,qBAAZ,EAAmCkI,GAAnC;AACA,aAAOrE,SAAP;AACD;AACF,GA5VgC,CA8VjC;AACA;;;AACe,QAAToB,SAAS,CAACvI,GAAD,EAAMuG,GAAN,EAAW;AACxB,QAAI,CAACA,GAAD,IAAQ,CAAC,KAAK1B,OAAL,CAAaC,KAA1B,EAAiC;AACjC,UAAM6G,IAAI,GAAG,KAAK9K,SAAL,CAAe8K,IAAf,KAAwB,KAAK9K,SAAL,CAAe8K,IAAf,GAAsB,EAA9C,CAAb;;AACA,UAAMC,UAAU,GAAG3K,gBAAEC,GAAF,CAAM,KAAKT,SAAX,EAAsB,8BAAtB,CAAnB;;AACA,UAAMoL,MAAM,GAAG5K,gBAAEC,GAAF,CAAM,KAAKT,SAAX,EAAsB,0BAAtB,CAAf;;AACA,UAAMqL,IAAI,GAAG,KAAKrL,SAAL,CAAesL,yBAA5B;AACA,QAAI,CAACD,IAAL,EAAW,MAAM,IAAIhK,KAAJ,CAAU,wCAAV,CAAN;AACX,UAAMkK,GAAG,GAAG,EAAC,GAAGhM;AAAJ,KAAZ;AACA,UAAM,+BAAciB,gBAAEQ,OAAF,CAAUqK,IAAV,CAAd,EAA+B,OAAO,CAAC7D,GAAD,EAAM/F,QAAN,CAAP,KAA2B;AAC9D,YAAM+J,QAAQ,GAAG,MAAM,KAAK9J,IAAL,CAAU8I,QAAV,CAAoBvD,GAAD,IAAS;AACjD,cAAMwE,IAAI,GAAGpB,QAAQ,CAACqB,aAAT,CAAuBzE,GAAvB,CAAb,CADiD,CAEjD;;AACA,eAAOwE,IAAI,CAACE,GAAL,IAAYF,IAAI,CAAC1C,IAAxB;AACD,OAJsB,EAIpBtH,QAJoB,CAAvB;;AAKA,UAAI+J,QAAJ,EAAc;AACZ,cAAMxH,IAAI,GAAG,MAAM,KAAK4H,SAAL,CAAe9F,GAAf,EAAoBvG,GAApB,EAAyBiI,GAAzB,EAA8B2D,UAA9B,EAA0CK,QAA1C,EAAoDJ,MAApD,CAAnB;;AACA,YAAIpH,IAAJ,EAAU;AACRuH,UAAAA,GAAG,CAAC/D,GAAD,CAAH,GAAWxD,IAAX;AACA;AACD;AACF;;AACD/B,MAAAA,OAAO,CAACC,GAAR,CAAa,0BAAyBsJ,QAAS,GAA/C;AACD,KAdK,CAAN;AAeAN,IAAAA,IAAI,CAAClI,IAAL,CAAUuI,GAAV;AACD;;AAEc,QAATK,SAAS,CAAC9F,GAAD,EAAMvG,GAAN,EAAWiI,GAAX,EAAgB2D,UAAhB,EAA4BK,QAA5B,EAAsCJ,MAAtC,EAA8C;AAC3D,UAAMS,GAAG,GAAGL,QAAQ,CAACM,MAAT,CAAgBN,QAAQ,CAACO,WAAT,CAAqB,GAArB,CAAhB,CAAZ;AACA,UAAMC,KAAK,GAAGH,GAAG,CAACE,WAAJ,CAAgB,GAAhB,CAAd;AACA,UAAME,GAAG,GAAGb,MAAM,KAAKY,KAAK,GAAG,CAAR,GAAYH,GAAZ,GAAkBA,GAAG,CAACC,MAAJ,CAAW,CAAX,EAAcE,KAAd,CAAvB,CAAlB;AACA,UAAME,QAAQ,GAAI,GAAEpG,GAAI,IAAGvG,GAAG,CAACA,GAAI,IAAGiI,GAAI,GAAEyE,GAAI,EAAhD,CAJ2D,CAIR;;AACnD,QAAI;AACF,UAAId,UAAU,KAAK,WAAnB,EAAgC;AAC9B,cAAMgB,UAAU,GAAG,MAAM,KAAKzK,IAAL,CAAU8B,IAAV,CAAegI,QAAf,CAAzB;;AACAlH,oBAAGa,aAAH,CAAiB+G,QAAjB,EAA2B,MAAMC,UAAU,CAACC,MAAX,EAAjC,EAAsD,QAAtD;AACD,OAHD,MAGO;AACL,cAAMzG,GAAG,GAAG,MAAM0G,eAAM5L,GAAN,CAAU+K,QAAV,EAAoB;AAAEc,UAAAA,YAAY,EAAE;AAAhB,SAApB,CAAlB;;AACAhI,oBAAGa,aAAH,CAAiB+G,QAAjB,EAA2B,IAAIK,MAAM,CAACpG,IAAX,CAAgBR,GAAG,CAAC6G,IAApB,CAA3B,EAAsD,QAAtD;AACD;;AACD,YAAMC,SAAS,GAAGP,QAAQ,CAACH,WAAT,CAAqB,GAArB,CAAlB;AACA,aAAOU,SAAS,IAAI,CAAb,GAAiBP,QAAQ,CAACJ,MAAT,CAAgBW,SAAS,GAAG,CAA5B,CAAjB,GAAkDA,SAAzD;AACD,KAVD,CAUE,OAAO/M,KAAP,EAAc;AACduC,MAAAA,OAAO,CAACC,GAAR,CAAa,kBAAiB3C,GAAG,CAAC2F,KAAM,uBAAsBsG,QAAS,KAAI9L,KAAM,EAAjF;AACD;;AACD,WAAO,EAAP;AACD;;AAEoC,QAA/B+G,+BAA+B,CAACsE,GAAD,EAAM;AACzC9I,IAAAA,OAAO,CAACC,GAAR,CAAY,yCAAZ;AACA,WAAO,MAAMwK,wBAAcC,KAAd,CAAoB5B,GAApB,EAAyB6B,IAAzB,CAA8B,CAAC;AAACC,MAAAA,GAAD;AAAMlL,MAAAA,CAAN;AAASgE,MAAAA,GAAT;AAAcmH,MAAAA;AAAd,KAAD,KAAyB;AAClE,aAAOhN,MAAM,CAACuH,IAAP,CAAY,KAAKrH,SAAL,CAAesH,oBAA3B,EAAiDyF,MAAjD,CAAwD,CAAC/B,GAAD,EAAMxD,GAAN,KAAc;AAC3E,cAAMwF,GAAG,GAAGrL,CAAC,CAAC,KAAK3B,SAAL,CAAesH,oBAAf,CAAoCE,GAApC,CAAD,CAAD,CAA4CyF,IAA5C,EAAZ;;AACA,YAAI,CAACjC,GAAD,IAAS,CAACgC,GAAd,EAAmB;AACjB/K,UAAAA,OAAO,CAACC,GAAR,CAAY,+BAAZ;AACA,iBAAOwE,SAAP;AACD;;AACDsE,QAAAA,GAAG,CAACxD,GAAD,CAAH,GAAWwF,GAAG,CAAC9I,OAAJ,CAAY,QAAZ,EAAsB,GAAtB,EAA2BA,OAA3B,CAAmC,SAAnC,EAA8C,EAA9C,CAAX;AACA,eAAO8G,GAAP;AACD,OARM,EAQJ,EARI,CAAP;AASD,KAVY,EAUVF,KAVU,CAUJlI,CAAC,IAAI;AACZ,WAAKC,MAAL,CAAY,qBAAZ,EAAmCkI,GAAnC;AACA,aAAOrE,SAAP;AACD,KAbY,CAAb;AAcD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;AACuB,QAAfwG,eAAe,CAACjG,GAAD,EAAM;AACzB,QAAIA,GAAG,KAAK,KAAZ,EAAmB;AAAE;AACnB,aAAO,MAAM,KAAKvF,IAAL,CAAUqJ,GAAV,EAAb;AACD;;AACD,WAAOrE,SAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;AACmB,QAAXuE,WAAW,CAACzD,GAAD,EAAM;AACrB,UAAMP,GAAG,GAAG,KAAKjH,SAAL,CAAesH,oBAAf,CAAoCE,GAApC,CAAZ;AACA,QAAIyF,IAAI,GAAG,EAAX;;AACA,QAAI;AACF,UAAIzM,gBAAEE,QAAF,CAAWuG,GAAX,CAAJ,EAAqB;AACnB,eAAQ,OAAM,KAAKiG,eAAL,CAAqBjG,GAArB,CAAN,MAAmC,MAAM,KAAK3E,WAAL,CAAiB2E,GAAjB,CAAzC,CAAR;AACD;;AACD,UAAIzG,gBAAEI,QAAF,CAAWqG,GAAX,MAAoBzG,gBAAEuG,OAAF,CAAUE,GAAG,CAACxF,QAAd,KAA2BjB,gBAAEE,QAAF,CAAWuG,GAAG,CAACxF,QAAf,CAA/C,CAAJ,EAA8E;AAC5E,cAAM0L,SAAS,GAAGlG,GAAG,CAACmG,IAAtB;AACA,cAAMC,SAAS,GAAGpG,GAAG,CAACoG,SAAJ,IAAiB,GAAnC;AACA,cAAMC,KAAK,GAAG9M,gBAAEuG,OAAF,CAAUE,GAAG,CAACxF,QAAd,IAA0BwF,GAAG,CAACxF,QAA9B,GAAyC,CAACwF,GAAG,CAACxF,QAAL,CAAvD;AACA,cAAM8L,KAAK,GAAG,MAAM,wBAAOD,KAAP,EAAc,OAAOE,GAAP,EAAYtM,IAAZ,KAAqB;AACrD,gBAAMuM,KAAK,GAAG,MAAM,KAAKP,eAAL,CAAqBhM,IAArB,CAApB;AACA,cAAIuM,KAAJ,EAAW,OAAO,CAAC,GAAGD,GAAJ,EAASC,KAAT,CAAP;AACX,gBAAMlL,OAAO,GAAG,MAAM,KAAKX,WAAL,CAAiBV,IAAjB,CAAtB;AACA,iBAAO,CAAC,GAAGsM,GAAJ,EAAS,IAAG,MAAM,2BAAUjL,OAAV,EAAmB,MAAOmL,MAAP,IAC1C,OAAOP,SAAS,GACZ,MAAM,KAAKzL,IAAL,CAAU8I,QAAV,CAAmB,CAACiB,IAAD,EAAO2B,IAAP,KAAgB3B,IAAI,CAACkC,YAAL,CAAkBP,IAAlB,CAAnC,EAA4DM,MAA5D,EAAoEP,SAApE,CADM,GAEZ,MAAM,CAAC,MAAMO,MAAM,CAAClL,WAAP,CAAmB,aAAnB,CAAP,EAA0CC,SAA1C,EAFV,CADuB,CAAT,CAAT,CAAP;AAKA,iBAAO+K,GAAP;AACD,SAVmB,EAUjB,EAViB,CAApB;AAWA,eAAOD,KAAK,CAAChG,MAAN,CAAaqG,CAAC,IAAI,CAAC,CAACA,CAApB,EAAuB3K,IAAvB,CAA4BoK,SAA5B,CAAP;AACD;;AACD,WAAKxK,MAAL,CAAY,8BAAZ,EAA4C2E,GAA5C;AACA,aAAOd,SAAP;AACD,KAvBD,SAuBU;AACR,UAAI,KAAKtC,OAAL,CAAa,gBAAb,CAAJ,EAAoC;AAClCnC,QAAAA,OAAO,CAACC,GAAR,CAAa,eAAcsF,GAAI,KAAIP,GAAI,KAAIgG,IAAK,GAAhD;AACD;AACF;AACF;;AAED5G,EAAAA,YAAY,CAACJ,KAAD,EAAQ;AAClB,WAAOA,KAAP;AACD;;AA3dgC;AA8dnC;;;;AACO,MAAM4H,SAAS,GAAG;AACvBC,EAAAA,WAAW,EAAE;AACXC,IAAAA,OAAO,EAAE,QADE;AAEX5M,IAAAA,KAAK,EAAG6M,CAAD,IAAO;AACZ,aAAOC,MAAM,CAACC,YAAP,CAAoBF,CAAC,CAACG,UAAF,CAAa,CAAb,IAAkB,MAAtC,CAAP;AACD;AAJU,GADU;AAOvBC,EAAAA,gBAAgB,EAAE;AAChBL,IAAAA,OAAO,EAAE,cADO;AAEhB5M,IAAAA,KAAK,EAAG6M,CAAD,IAAO;AACZ,aAAOC,MAAM,CAACC,YAAP,CAAoBF,CAAC,CAACG,UAAF,CAAa,CAAb,IAAkB,MAAtC,CAAP;AACD;AAJe,GAPK;AAavBE,EAAAA,gBAAgB,EAAE;AAChBN,IAAAA,OAAO,EAAE,KADO;AAEhB5M,IAAAA,KAAK,EAAE;AAFS,GAbK;AAiBvBmN,EAAAA,IAAI,EAAE,CAAE;AAAEP,IAAAA,OAAO,EAAE,MAAX;AAAmB5M,IAAAA,KAAK,EAAE;AAA1B,GAAF,EACE;AAAE4M,IAAAA,OAAO,EAAE,MAAX;AAAmB5M,IAAAA,KAAK,EAAE;AAA1B,GADF,CAjBiB;AAmBvBoN,EAAAA,UAAU,EAAE;AACVR,IAAAA,OAAO,EAAE,QADC;AAEV5M,IAAAA,KAAK,EAAE;AAFG,GAnBW;AAuBvBqN,EAAAA,SAAS,EAAE;AACTT,IAAAA,OAAO,EAAE,QADA;AAET5M,IAAAA,KAAK,EAAE;AAFE;AAvBY,CAAlB","sourcesContent":["import _ from 'lodash';\nimport axios from 'axios';\nimport fs from 'fs';\nimport { forEachSeries, mapSeries, every, reduce, some } from 'p-iteration';\nimport cheerioClient from 'cheerio-httpcli';\nimport Mustache from 'mustache';\n\nimport WriterCreator from '../util/WriterCreator';\nimport Replacer from '../util/Replacer';\nimport Constants from '../constants';\n\nconst DEFAULT_PRODUCT_TEXTS_CHECK_DEF = {\n  jan: {\n    regexp: '^\\\\d+$',\n    option: '',\n    error: 'JANが数字のみになっていません',\n  },\n};\n\nexport default class JanSearchBase {\n  constructor(args) {\n    Object.assign(this, args);\n    // this.outputDir = outputDir;\n    // this.page = page;\n    // this.errors = errors;\n    // this.rc = rc;\n    this.srcConfig = this.getSrcConfig();\n    this.timeout = Constants.timeout;\n    this.imageInfo = {};\n    this.updateSiteInformation();\n    this.replacer = new Replacer(this.srcConfig.replacer, _.get(this, 'rc.replacer'));\n  }\n\n  updateSiteInformation() {\n    if (_.isString(this.siteKey) && _.isObject(_.get(this, `rc.site[${this.siteKey}]`))) {\n      const custom = this.rc.site[this.siteKey];\n      if (_.isObject(custom)) {\n        _.toPairs(custom).forEach(([path, value]) => _.set(this.srcConfig, path, value));\n      } else {\n        throw new Error(`rc file site[${this.siteKey}] is not Object.`);\n      }\n    }\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * セレクタの要素を複数取得します。スラッシュ始まりの場合、XPath形式とみなします。\n   * @param {string} selector\n   * @return {Array<Promise>} 選択した要素\n   */\n  async xselectLink(selector) {\n    return selector.startsWith('/')\n      ? await this.page.$x(selector)\n      : await this.page.$$(selector);\n  }\n\n  async xselectClick(selector) {\n    if (selector) {\n      console.log(`*** xselectClick ${selector} ***`);\n      const link = await this.xselectLink(selector);\n      if (link.length > 0) {\n        console.log(`*** xselectClick ${selector} click`);\n        await link[0].click();\n        await this.waitLoaded();\n      }\n    }\n  }\n\n  async xselectText(selector) {\n    const targets = await this.xselectLink(selector);\n    if (targets.length > 0) {\n      return await (await targets[0].getProperty('textContent')).jsonValue();\n    }\n    return '';\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  async init() {\n  }\n\n  /**\n   * 検索設定定義を返す。\n   * @return {Object} 検索設定定義\n   * @property {String} prefix 出力プリフィックス\n   * @property {String} top アクセス先頭ページ\n   * @property {String} searchPageSelectors.searchText 検索文字列セレクタ\n   * @property {String} searchPageSelectors.searchButton 検索ボタンセレクタ\n   * @property {String} searchPageSelectors.nextLink 次へリンクセレクタ。XmlPathも設定可能\n   * @property {String} searchPageSelectors.productsLink 商品ページリンクセレクタ\n   * @property {String|Object} productPageSelectors.{カラム} データ取得セレクタ。\n   *           オブジェクトの場合には、selにセレクタ、methodに取得メソッドを指定する。\n   * @property {Array<Object>} replacer.{カラム} データ変換定義。patternに正規表現、valueに置き換え後の文字列。\n   */\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    const config = this.srcConfig;\n    console.log(`*** janSearch[${config.prefix}] ***`);\n    await this.page.goto(config.top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    // await this.page.screenshot( { path: './top.png' });\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.srcConfig;\n    await this.page.waitForSelector(config.searchPageSelectors.searchText);\n    const name = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}`;\n    const outputFile = `${name}.csv`;\n    if (this.options.image && !fs.existsSync(name)) {\n      console.log(`mkdir ${name}`);\n      fs.mkdirSync(name);\n    }\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.xselectClick(config.searchPageSelectors.cushion); // 検索結果がすぐに出ない画面の場合、リンクをクリックする\n    await this.eachItemFromSearchResult(name);\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n    if (!_.isEmpty(this.imageInfo)) {\n      this.imageInfo.title = word;\n      fs.writeFileSync(`${name}/data.json`, JSON.stringify(this.imageInfo, null, 2));\n      const tmpl = `${__dirname}/../../tmpl/template.html`;\n      const tmplBody = fs.readFileSync(tmpl, {encoding: \"utf-8\"});\n      const res = Mustache.render(tmplBody, this.imageInfo);\n      fs.writeFileSync(`${name}/index.html`, res, 'utf-8');\n    }\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報を返します。\n   */\n  async eachItemFromSearchResult(dir) {\n    console.log('*** eachItemFromSearchResult ***');\n    const hasDupLinks = await this.getAllJanUrls();\n    const links = Array.from(new Set(this.filterJanUrl(hasDupLinks)));\n    console.log('** LINKS', links);\n    let skipCheerio = false;\n    const result = await mapSeries(links, async (link, idx) => {\n      try {\n        console.log(`PRODUCTS[${idx + 1}/${links.length}]`);\n        let jan;\n        if (this.options['enable-cheerio-httpcli'] && !skipCheerio) {\n          jan = await this.getProductTextsByCheerioHttpcli(link);\n          skipCheerio = jan === undefined;\n        }\n        if (!jan) jan = await this.getProductTexts(link);\n        if (!jan) return;\n        const replacedJan = this.replacer.replaceValues(jan);\n        // ページをスキップする判断をする\n        const skipInfo = _.isArray(this.srcConfig.productPageSkipSelectors) ?  this.srcConfig.productPageSkipSelectors : undefined;\n        if (skipInfo) {\n          // skipセレクタの要素を検索して存在を確認する\n          if (await some(skipInfo, async (sel) => (await this.xselectLink(sel)).length > 0)) {\n            console.log('対象外になるためスキップします。', link);\n            return;\n          }\n        }\n        const nullables = Object.assign({}, this.srcConfig.nullables || {});\n        const checkers = Object.assign({}, DEFAULT_PRODUCT_TEXTS_CHECK_DEF, this.srcConfig.checkers || {});\n        // 必須項目のチェック\n        const allOk = Object.keys(this.srcConfig.productPageSelectors)\n          .filter((key) => !_.isString(nullables[key]))\n          .every((key) => {\n            const chk = checkers[key];\n            if (chk) {\n              const reg = new RegExp(chk.regexp, chk.option);\n              if (!reg.test(replacedJan[key])) {\n                this.addErr(chk.error, link);\n                return false;\n              }\n            } else if (!_.isString(replacedJan[key]) || replacedJan[key].length === 0) {\n              this.addErr(`キー[${key}] の値が取得できず空文字列になっています。`, link);\n              return false;\n            }\n            return true;\n          });\n        if (!allOk) return;\n        await this.getImages(replacedJan, dir);\n        this.writer.write(replacedJan);\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.srcConfig;\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.onlyCurrentPage) {\n      return this.getAllJanUrlsOnlyCurrentPage();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  /**\n   * 商品ページをカレントページないからのみ取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsOnlyCurrentPage() {\n    console.log('*** getAllJanUrlsOnlyCurrentPage ***');\n    const nextSel = this.srcConfig.searchPageSelectors.nextLink;\n    if (nextSel) {\n      let page = 1;\n      let nexts;\n      // カレントページのボタンをクリックし対象を増やす\n      while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n        console.log(`PAGE ${++page}`);\n        await nexts[0].click();\n        await this.waitLoaded();\n        await this.page.waitFor(20000);\n      }\n    }\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  /**\n   * 商品ページを次ページボタンの遷移で取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    const nextSel = this.srcConfig.searchPageSelectors.nextLink;\n    const waitSel = this.srcConfig.searchPageSelectors.productsPageWaiter; // ページ遷移後、セレクタが出るまで待つ\n    const pageCntSel = this.srcConfig.searchPageSelectors.productsPageCounter; // ページ遷移結果チェックを行う\n    const links = await this.waitAndGetProductsLink(waitSel, productsSel);\n    let pageObj = await this.getPageCntInfo({}, pageCntSel);\n    let nexts;\n    while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n      await nexts[0].click();\n      await this.waitLoaded();\n      pageObj = await this.getPageCntInfo(pageObj, pageCntSel);\n      if (pageObj.isSame) {\n        break; // ページ遷移結果チェックがある場合、ページ遷移が行われなかった場合にそこで終わりとする\n      }\n      console.log(`PAGE ${++page}`);\n      links.push(... await this.waitAndGetProductsLink(waitSel, productsSel));\n    }\n    return links;\n  }\n\n  async waitAndGetProductsLink(waitSel, productsSel) {\n    await this.waitProductsPage(waitSel);\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async waitProductsPage(selectArgs) {\n    if (_.isArray(selectArgs)) {\n      console.log('*** waitProductsPage ***');\n      await this.page.waitForSelector(...selectArgs);\n    }\n  }\n\n  async getPageCntInfo(lastPageObj, pageSel) {\n    const curPageObj = {};\n    if (pageSel) {\n      curPageObj.pageText = await this.xselectText(pageSel);\n      curPageObj.isSame = _.eq(lastPageObj.pageText, curPageObj.pageText);\n      console.log('*** getPageCntInfo: page check ***', curPageObj);\n    } else {\n      curPageObj.isSame = false;\n    }\n    return curPageObj;\n  }\n\n  /**\n   * 商品ページをカレントページを下に移動してAjaxで画面を更新し最後までスクロールして取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n  /**\n   * 商品ページからproductPageSelectorsに定義された情報を取得します。\n   */\n  async getProductTexts(url) {\n    console.log('*** getProductTexts ***');\n    await this.page.goto(url, {waitUntil: 'networkidle2'});\n    try {\n      const result =  await reduce(Object.keys(this.srcConfig.productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {});\n      return result;\n    } catch (e) {\n      console.log(e);\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    }\n  }\n\n  // TODO: puppeteerダウンロードモード追加\n  // https://www.webtomoblg.net/web/puppeteer-practice/#toc2\n  async getImages(jan, dir) {\n    if (!dir || !this.options.image) return;\n    const rows = this.imageInfo.rows || (this.imageInfo.rows = []);\n    const downloader = _.get(this.srcConfig, 'productPageImages.downloader');\n    const suffix = _.get(this.srcConfig, 'productPageImages.suffix');\n    const imgs = this.srcConfig.productPageImageSelectors;\n    if (!imgs) throw new Error('Not defined productPageImageSelectors!');\n    const row = {...jan};\n    await forEachSeries(_.toPairs(imgs), async ([key, selector]) => {\n      const imageSrc = await this.page.evaluate((sel) => {\n        const node = document.querySelector(sel);\n        // img.src or a tag\n        return node.src || node.href;\n      }, selector);\n      if (imageSrc) {\n        const name = await this.saveImage(dir, jan, key, downloader, imageSrc, suffix);\n        if (name) {\n          row[key] = name;\n          return;\n        }\n      }\n      console.log(`Couldn't get image src ${imageSrc}.`);\n    });\n    rows.push(row);\n  }\n\n  async saveImage(dir, jan, key, downloader, imageSrc, suffix) {\n    const ext = imageSrc.substr(imageSrc.lastIndexOf('.'));\n    const query = ext.lastIndexOf('?');\n    const suf = suffix || (query < 0 ? ext : ext.substr(0, query));\n    const saveFile = `${dir}/${jan.jan}_${key}${suf}`; // 保存ファイルフルパス\n    try {\n      if (downloader === 'puppeteer') {\n        const viewSource = await this.page.goto(imageSrc);\n        fs.writeFileSync(saveFile, await viewSource.buffer(), 'binary');\n      } else {\n        const res = await axios.get(imageSrc, { responseType: 'arraybuffer' });\n        fs.writeFileSync(saveFile, new Buffer.from(res.data), 'binary');\n      }\n      const lastSlash = saveFile.lastIndexOf('/');\n      return lastSlash >= 0 ? saveFile.substr(lastSlash + 1) : lastSlash;\n    } catch (error) {\n      console.log(`[Image] image [${jan.title}] Couldn't get from ${imageSrc}. ${error}`);\n    }\n    return '';\n  }\n\n  async getProductTextsByCheerioHttpcli(url) {\n    console.log('*** getProductTextsByCheerioHttpcli ***');\n    return await cheerioClient.fetch(url).then(({err, $, res, body}) => {\n      return Object.keys(this.srcConfig.productPageSelectors).reduce((acc, key) => {\n        const txt = $(this.srcConfig.productPageSelectors[key]).text();\n        if (!acc  || !txt) {\n          console.log('getJanByCheerioHttpcli failed');\n          return undefined;\n        }\n        acc[key] = txt.replace(/[\\s　]+/, ' ').replace(/[\\r\\n]/g, '');\n        return acc;\n      }, {});\n    }).catch(e => {\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    });\n  }\n\n  /**\n   * 特定キーワードの文字列からデータに変換して返します。\n   * 特定キーワードは現在以下の通り。\n   * url: ページURL\n   *\n   * @param {String} sel 特定キーワード\n   * @return {String} 取得した値(取得できない場合には空文字列)\n   */\n  async specialPageText(sel) {\n    if (sel === 'url') { // url文字列の場合、url値を使う\n      return await this.page.url();\n    }\n    return undefined;\n  }\n\n  /**\n   * プロダクトページから productPageSelectors に定義されているテキストを取得します。\n   * 定義がテキストの場合には、単純セレクタで単純文字列の取得を行います。\n   * 定義がオブジェクトの場合には、path がセレクタで、複数ヒット・配列定義が可能。\n   * また、attr がある場合にはnodeの属性から値を取得します。\n   * @param {String} key データ取得キー\n   * @return {String} 取得できたテキスト\n   */\n  async getPageText(key) {\n    const sel = this.srcConfig.productPageSelectors[key];\n    let text = '';\n    try {\n      if (_.isString(sel)) {\n        return (await this.specialPageText(sel) || await this.xselectText(sel));\n      }\n      if (_.isObject(sel) && (_.isArray(sel.selector) || _.isString(sel.selector))) {\n        const attribute = sel.attr;\n        const separator = sel.separator || '・';\n        const paths = _.isArray(sel.selector) ? sel.selector : [sel.selector];\n        const texts = await reduce(paths, async (arr, path) => {\n          const spVal = await this.specialPageText(path);\n          if (spVal) return [...arr, spVal];\n          const targets = await this.xselectLink(path);\n          return [...arr, ...await mapSeries(targets, async (target) => (\n            await (attribute\n              ? await this.page.evaluate((node, attr) => node.getAttribute(attr), target, attribute)\n              : await (await target.getProperty('textContent')).jsonValue()\n          )))];\n          return arr;\n        }, []);\n        return texts.filter(v => !!v).join(separator);\n      }\n      this.addErr('productPageSelectorsの定義が不正です', key);\n      return undefined;\n    } finally {\n      if (this.options['debug-pagetext']) {\n        console.log(`getPageText[${key}][${sel}][${text}]`);\n      }\n    }\n  }\n\n  filterJanUrl(links) {\n    return links;\n  }\n}\n\n/** 共通リプレーサ定義 */\nexport const REPLACERS = {\n  toHarfWidth: {\n    pattern: /[！-～]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthAlnum: {\n    pattern: /[Ａ-Ｚａ-ｚ０-９]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthSpace: {\n    pattern: /　+/g,\n    value: ' ',\n  },\n  trim: [ { pattern: /^\\s+/, value: '' },\n          { pattern: /\\s+$/, value: '' } ],\n  toOneSpace: {\n    pattern: /\\s\\s+/g,\n    value: ' ',\n  },\n  toOneLine: {\n    pattern: /\\r?\\n/g,\n    value: ' ',\n  },\n};\n"],"file":"JanSearchBase.js"}