{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["JanSearchBase","args","Object","assign","timeout","Constants","replacer","Replacer","getSrcConfig","_","get","imageInfo","selectors","length","selector","page","$","startsWith","$x","$$","console","log","xselectLink","link","click","waitLoaded","waitForNavigation","waitUntil","errs","errors","push","join","keywords","goto","top","init","keyword","searchWord","word","config","name","outputDir","prefix","replace","outputFile","options","image","fs","existsSync","mkdirSync","writer","WriterCreator","createCsvWriter","type","searchPageSelectors","searchText","searchButton","xselectClick","cushion","eachItemFromSearchResult","close","isEmpty","title","writeFileSync","JSON","stringify","tmpl","__dirname","tmplBody","readFileSync","encoding","res","Mustache","render","dir","getAllJanUrls","hasDupLinks","links","Array","from","Set","filterJanUrl","skipCheerio","idx","jan","getJanByCheerioHttpcli","undefined","getJan","replacedJan","replaceValues","test","addErr","getImage","write","result","scrollToBottom","getAllJanUrlsScrollToBottom","nextLink","getAllJanUrlsPageTransition","productsSel","productsLink","nextSel","$$eval","list","map","item","href","nexts","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","url","keys","productPageSelectors","acc","key","getPageText","rows","imgs","productPageImageSelectors","Error","row","toPairs","node","querySelector","src","imageSrc","cheerioClient","fetch","then","err","body","reduce","txt","text","sel","targets","getProperty","jsonValue","REPLACERS","toHarfWidth","pattern","value","s","String","fromCharCode","charCodeAt","toHarfWidthAlnum","toHarfWidthSpace","trim","toOneSpace","toOneLine"],"mappings":"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","file":"JanSearchBase.js","sourcesContent":["import _ from 'lodash';\nimport fs from 'fs';\nimport { forEachSeries, map, mapSeries, every, reduce } from 'p-iteration';\nimport cheerioClient from 'cheerio-httpcli';\nimport Mustache from 'mustache';\n\nimport WriterCreator from '../util/WriterCreator';\nimport imageDownload from '../util/ImageDownload';\nimport Replacer from '../util/Replacer';\nimport Constants from '../constants';\n\nexport default class JanSearchBase {\n\n  constructor(args) {\n    Object.assign(this, args);\n    // this.outputDir = outputDir;\n    // this.page = page;\n    // this.errors = errors;\n    // this.rc = rc;\n    this.timeout = Constants.timeout;\n    this.replacer = new Replacer(this.getSrcConfig().replacer, _.get(this, 'rc.replacer'));\n    this.imageInfo = {};\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * セレクタの要素を複数取得します。スラッシュ始まりの場合、XPath形式とみなします。\n   * @param {string} selector\n   * @return {Array<Promise>} 選択した要素\n   */\n  async xselectLink(selector) {\n    return selector.startsWith('/')\n      ? await this.page.$x(selector)\n      : await this.page.$$(selector);\n  }\n\n  async xselectClick(selector) {\n    if (selector) {\n      console.log(`*** xselectClick ${selector} ***`);\n      const link = await this.xselectLink(selector);\n      if (link.length > 0) {\n        console.log(`*** xselectClick ${selector} click`);\n        await link[0].click();\n        await this.waitLoaded();\n      }\n    }\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  async init() {\n  }\n\n  /**\n   * 検索設定定義を返す。\n   * @return {Object} 検索設定定義\n   * @property {String} prefix 出力プリフィックス\n   * @property {String} top アクセス先頭ページ\n   * @property {String} searchPageSelectors.searchText 検索文字列セレクタ\n   * @property {String} searchPageSelectors.searchButton 検索ボタンセレクタ\n   * @property {String} searchPageSelectors.nextLink 次へリンクセレクタ。XmlPathも設定可能\n   * @property {String} searchPageSelectors.productsLink 商品ページリンクセレクタ\n   * @property {String|Object} productPageSelectors.{カラム} データ取得セレクタ。\n   *           オブジェクトの場合には、selにセレクタ、methodに取得メソッドを指定する。\n   * @property {Array<Object>} replacer.{カラム} データ変換定義。patternに正規表現、valueに置き換え後の文字列。\n   */\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    console.log('*** janSearch ***');\n    await this.page.goto(this.getSrcConfig().top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.getSrcConfig();\n    const name = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}`;\n    const outputFile = `${name}.csv`;\n    if (this.options.image && !fs.existsSync(name)) {\n      console.log(`mkdir ${name}`);\n      fs.mkdirSync(name);\n    }\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.xselectClick(config.searchPageSelectors.cushion);\n    await this.eachItemFromSearchResult(name);\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n    if (!_.isEmpty(this.imageInfo)) {\n      this.imageInfo.title = word;\n      fs.writeFileSync(`${name}/data.json`, JSON.stringify(this.imageInfo, null, 2));\n      const tmpl = `${__dirname}/../../tmpl/template.html`;\n      const tmplBody = fs.readFileSync(tmpl, {encoding: \"utf-8\"});\n      const res = Mustache.render(tmplBody, this.imageInfo);\n      fs.writeFileSync(`${name}/index.html`, res, 'utf-8');\n    }\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。\n   */\n  async eachItemFromSearchResult(dir) {\n    console.log('*** eachItemFromSearchResult ***');\n    const hasDupLinks = await this.getAllJanUrls();\n    const links = Array.from(new Set(this.filterJanUrl(hasDupLinks)));\n    console.log('** LINKS', links);\n    let skipCheerio = false;\n    const result = await mapSeries(links, async (link, idx) => {\n      try {\n        console.log(`PRODUCTS[${idx+1}/${links.length}]`);\n        let jan;\n        if (this.options['enable-cheerio-httpcli'] && !skipCheerio) {\n          jan = await this.getJanByCheerioHttpcli(link);\n          skipCheerio = jan === undefined;\n        }\n        if (!jan) jan = await this.getJan(link);\n        if (!jan) return;\n        const replacedJan = this.replacer.replaceValues(jan);\n        if (typeof replacedJan.jan !== 'string' || !replacedJan.jan || /\\D/.test(`${replacedJan.jan}`)) {\n          this.addErr('JANが数字のみになっていません', link);\n          return;\n        }\n        await this.getImage(replacedJan, dir);\n       this.writer.write(replacedJan);\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n        return;\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.getSrcConfig();\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    const nextSel = this.getSrcConfig().searchPageSelectors.nextLink;\n    const links = await this.page.$$eval(productsSel, list => list.map(item => item.href));\n    let nexts;\n    while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n      console.log(`PAGE ${++page}`);\n      await nexts[0].click();\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsSel, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.getSrcConfig().searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n  /**\n   * 商品ページからjan情報をかえします。\n   */\n  async getJan(url) {\n    console.log('*** getJan ***');\n    await this.page.goto(url, {waitUntil: 'networkidle2'});\n    try {\n      const result =  await reduce(Object.keys(this.getSrcConfig().productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {});\n      return result;\n    } catch (e) {\n      console.log(e);\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    }\n  }\n\n  async getImage(jan, dir) {\n    if (!dir || !this.options.image) return;\n    const rows = this.imageInfo.rows || (this.imageInfo.rows = []);\n    const imgs = this.getSrcConfig().productPageImageSelectors;\n    if (!imgs) throw new Error('Not defined productPageImageSelectors!');\n    const row = {...jan};\n    await forEachSeries(_.toPairs(imgs), async ([key, selector]) => {\n      const imageSrc = await this.page.evaluate((selector) => {\n        const node = document.querySelector(selector);\n        // img.src or a tag\n        return node.src || node.href;\n      }, selector);\n      if (imageSrc) {\n        row[key] = await imageDownload(jan.title, imageSrc, `${dir}/${jan.jan}_${key}`);\n      } else {\n        console.log(`Couldn't get image src ${imageSrc}.`);\n      }\n    });\n    rows.push(row);\n  }\n\n  async getJanByCheerioHttpcli(url) {\n    console.log('*** getJanByCheerioHttpcli ***');\n    return await cheerioClient.fetch(url).then(({err, $, res, body}) => {\n      return Object.keys(this.getSrcConfig().productPageSelectors).reduce((acc, key) => {\n        const txt = $(this.getSrcConfig().productPageSelectors[key]).text();\n        if (!acc  || !txt) {\n          console.log('getJanByCheerioHttpcli failed');\n          return undefined;\n        }\n        acc[key] = txt.replace(/[\\s　]+/, ' ').replace(/[\\r\\n]/g, '');\n        return acc;\n      }, {});\n    }).catch(e => {\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    });\n  }\n\n  /**\n   * プロダクトページから productPageSelectors に定義されているテキストを取得します。\n   * @param {String} key データ取得キー\n   * @return {String} 取得できたテキスト\n   */\n  async getPageText(key) {\n    const sel = this.getSrcConfig().productPageSelectors[key];\n    let text = '';\n    try {\n      const targets = await this.xselectLink(sel);\n      if (targets.length > 0) {\n        text = await (await targets[0].getProperty('textContent')).jsonValue();\n      }\n      return text;\n    } finally {\n      if (this.options['debug-pagetext']) {\n        console.log(`getPageText[${key}][${sel}][${text}]`);\n      }\n    }\n  }\n\n  filterJanUrl(links) {\n    return links;\n  }\n}\n\n/** 共通リプレーサ定義 */\nexport const REPLACERS = {\n  toHarfWidth: {\n    pattern: /[！-～]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthAlnum: {\n    pattern: /[Ａ-Ｚａ-ｚ０-９]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthSpace: {\n    pattern: /　+/g,\n    value: ' ',\n  },\n  trim: [ { pattern: /^\\s+/, value: '' },\n          { pattern: /\\s+$/, value: '' } ],\n  toOneSpace: {\n    pattern: /\\s\\s+/g,\n    value: ' ',\n  },\n  toOneLine: {\n    pattern: /\\r?\\n/g,\n    value: ' ',\n  }\n}\n"]}