{"version":3,"sources":["../../src/site/JanSearchBase.js"],"names":["DEFAULT_PRODUCT_TEXTS_CHECK_DEF","jan","regexp","option","error","JanSearchBase","constructor","args","Object","assign","srcConfig","getSrcConfig","timeout","Constants","replacer","Replacer","_","get","imageInfo","existsAll","selectors","length","selector","page","$","xselectLink","startsWith","$x","$$","xselectClick","console","log","link","click","waitLoaded","waitForNavigation","waitUntil","e","addErr","errs","errors","push","join","init","setNewReader","search","keywords","config","prefix","goto","top","keyword","searchWord","word","waitForSelector","searchPageSelectors","searchText","name","outputDir","replace","outputFile","options","image","fs","existsSync","mkdirSync","writer","WriterCreator","createCsvWriter","type","searchButton","cushion","eachItemFromSearchResult","close","isEmpty","title","writeFileSync","JSON","stringify","tmpl","__dirname","tmplBody","readFileSync","encoding","res","Mustache","render","dir","hasDupLinks","getAllJanUrls","links","Array","from","Set","filterJanUrl","skipCheerio","result","idx","getProductTextsByCheerioHttpcli","undefined","getPproductTexts","replacedJan","replaceValues","nullables","checkers","allOk","keys","productPageSelectors","filter","key","isString","every","chk","reg","RegExp","test","getImage","write","scrollToBottom","getAllJanUrlsScrollToBottom","nextLink","getAllJanUrlsPageTransition","onlyCurrentPage","getAllJanUrlsOnlyCurrentPage","productsSel","productsLink","$$eval","list","map","item","href","nextSel","nexts","viewport","height","viewportHeight","getScrollHeight","Promise","resolve","document","documentElement","scrollHeight","evaluate","currentPosition","scrollNumber","nextPosition","scrollTo","window","catch","url","acc","getPageText","rows","imgs","productPageImageSelectors","Error","row","toPairs","imageSrc","node","querySelector","src","cheerioClient","fetch","then","err","body","reduce","txt","text","sel","targets","getProperty","jsonValue","REPLACERS","toHarfWidth","pattern","value","s","String","fromCharCode","charCodeAt","toHarfWidthAlnum","toHarfWidthSpace","trim","toOneSpace","toOneLine"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport fs from 'fs';\nimport { forEachSeries, map, mapSeries, every, reduce } from 'p-iteration';\nimport cheerioClient from 'cheerio-httpcli';\nimport Mustache from 'mustache';\n\nimport WriterCreator from '../util/WriterCreator';\nimport imageDownload from '../util/ImageDownload';\nimport Replacer from '../util/Replacer';\nimport Constants from '../constants';\n\nconst DEFAULT_PRODUCT_TEXTS_CHECK_DEF = {\n  jan: {\n    regexp: '^\\\\d+$',\n    option: '',\n    error: 'JANが数字のみになっていません',\n  },\n};\n\nexport default class JanSearchBase {\n  constructor(args) {\n    Object.assign(this, args);\n    // this.outputDir = outputDir;\n    // this.page = page;\n    // this.errors = errors;\n    // this.rc = rc;\n    this.srcConfig = this.getSrcConfig();\n    this.timeout = Constants.timeout;\n    this.replacer = new Replacer(this.srcConfig.replacer, _.get(this, 'rc.replacer'));\n    this.imageInfo = {};\n  }\n\n  /**\n   * セレクタが全て存在するかチェックします。\n   * @param {*} selectors\n   */\n  async existsAll(...selectors) {\n    return selectors.length > 0 && every(selectors, async (selector) => (await this.page.$(selector)) !== null);\n  }\n\n  /**\n   * セレクタの要素を複数取得します。スラッシュ始まりの場合、XPath形式とみなします。\n   * @param {string} selector\n   * @return {Array<Promise>} 選択した要素\n   */\n  async xselectLink(selector) {\n    return selector.startsWith('/')\n      ? await this.page.$x(selector)\n      : await this.page.$$(selector);\n  }\n\n  async xselectClick(selector) {\n    if (selector) {\n      console.log(`*** xselectClick ${selector} ***`);\n      const link = await this.xselectLink(selector);\n      if (link.length > 0) {\n        console.log(`*** xselectClick ${selector} click`);\n        await link[0].click();\n        await this.waitLoaded();\n      }\n    }\n  }\n\n  /**\n   * ページロードを待ちます。\n   */\n  async waitLoaded() {\n    console.log('*** waitLoaded ***');\n    try {\n      await this.page.waitForNavigation({ timeout: this.timeout, waitUntil: 'domcontentloaded'});\n    } catch (e) {\n      // ignore.\n    }\n  }\n\n  addErr(...errs) {\n    this.errors.push(errs.join(','));\n  }\n\n  async init() {\n  }\n\n  /**\n   * 検索設定定義を返す。\n   * @return {Object} 検索設定定義\n   * @property {String} prefix 出力プリフィックス\n   * @property {String} top アクセス先頭ページ\n   * @property {String} searchPageSelectors.searchText 検索文字列セレクタ\n   * @property {String} searchPageSelectors.searchButton 検索ボタンセレクタ\n   * @property {String} searchPageSelectors.nextLink 次へリンクセレクタ。XmlPathも設定可能\n   * @property {String} searchPageSelectors.productsLink 商品ページリンクセレクタ\n   * @property {String|Object} productPageSelectors.{カラム} データ取得セレクタ。\n   *           オブジェクトの場合には、selにセレクタ、methodに取得メソッドを指定する。\n   * @property {Array<Object>} replacer.{カラム} データ変換定義。patternに正規表現、valueに置き換え後の文字列。\n   */\n  getSrcConfig() {\n  }\n\n  setNewReader() {\n  }\n\n  /**\n   * 引数で渡された検索ワードを検索して jan 情報を返します。\n   */\n  async search(...keywords) {\n    const config = this.srcConfig;\n    console.log(`*** janSearch[${config.prefix}] ***`);\n    await this.page.goto(config.top, {waitUntil: 'networkidle2'});\n    await this.init(); // 検索できる画面までの画面処理をする。\n    // await this.page.screenshot( { path: './top.png' });\n    await forEachSeries(keywords, async keyword => await this.searchWord(keyword));\n  }\n\n  /**\n   * １キーワードの検索処理を行って、すべてのjan情報を返します。\n   * @param {*} word\n   */\n  async searchWord(word) {\n    console.log(`*** search[${word}] ***`);\n    const config = this.srcConfig;\n    await this.page.waitForSelector(config.searchPageSelectors.searchText);\n    const name = `${this.outputDir}/${config.prefix}_${word.replace(/ +/g, '_')}`;\n    const outputFile = `${name}.csv`;\n    if (this.options.image && !fs.existsSync(name)) {\n      console.log(`mkdir ${name}`);\n      fs.mkdirSync(name);\n    }\n    this.writer = WriterCreator.createCsvWriter(outputFile)\n    await this.page.type(config.searchPageSelectors.searchText, word);\n    await this.page.click(config.searchPageSelectors.searchButton);\n    await this.waitLoaded();\n    await this.xselectClick(config.searchPageSelectors.cushion); // 検索結果がすぐに出ない画面の場合、リンクをクリックする\n    await this.eachItemFromSearchResult(name);\n    this.writer.close();\n    console.log(`Output done. [${outputFile}]`);\n    if (!_.isEmpty(this.imageInfo)) {\n      this.imageInfo.title = word;\n      fs.writeFileSync(`${name}/data.json`, JSON.stringify(this.imageInfo, null, 2));\n      const tmpl = `${__dirname}/../../tmpl/template.html`;\n      const tmplBody = fs.readFileSync(tmpl, {encoding: \"utf-8\"});\n      const res = Mustache.render(tmplBody, this.imageInfo);\n      fs.writeFileSync(`${name}/index.html`, res, 'utf-8');\n    }\n  }\n\n  /**\n   * 検索結果画面の商品分のリンク先を取得し、すべてのjan情報をかえします。\n   */\n  async eachItemFromSearchResult(dir) {\n    console.log('*** eachItemFromSearchResult ***');\n    const hasDupLinks = await this.getAllJanUrls();\n    const links = Array.from(new Set(this.filterJanUrl(hasDupLinks)));\n    console.log('** LINKS', links);\n    let skipCheerio = false;\n    const result = await mapSeries(links, async (link, idx) => {\n      try {\n        console.log(`PRODUCTS[${idx+1}/${links.length}]`);\n        let jan;\n        if (this.options['enable-cheerio-httpcli'] && !skipCheerio) {\n          jan = await this.getProductTextsByCheerioHttpcli(link);\n          skipCheerio = jan === undefined;\n        }\n        if (!jan) jan = await this.getPproductTexts(link);\n        if (!jan) return;\n        const replacedJan = this.replacer.replaceValues(jan);\n        const nullables = Object.assign({}, this.srcConfig.nullables || {});\n        const checkers = Object.assign({}, DEFAULT_PRODUCT_TEXTS_CHECK_DEF, this.srcConfig.checkers || {});\n        // 必須項目のチェック\n        const allOk = Object.keys(this.srcConfig.productPageSelectors)\n          .filter((key) => !_.isString(nullables[key]))\n          .every((key) => {\n            const chk = checkers[key];\n            if (chk) {\n              const reg = new RegExp(chk.regexp, chk.option);\n              if (!reg.test(replacedJan[key])) {\n                this.addErr(chk.error, link);\n                return false;\n              }\n            } else if (!_.isString(replacedJan[key]) || replacedJan[key].length === 0) {\n              this.addErr(`キー[${key}] の値が取得できず空文字列になっています。`, link);\n              return false;\n            }\n            return true;\n          });\n        if (!allOk) return;\n        await this.getImage(replacedJan, dir);\n        this.writer.write(replacedJan);\n      } catch (e) {\n        this.addErr('商品ページへ移動できませんでした', link, e);\n      }\n    });\n  }\n\n  /**\n   * 検索結果ページの商品URLをすべて取得します。次ページがある場合にはすべてのページを取得します。\n   */\n  async getAllJanUrls() {\n    console.log('*** getAllJanUrls ***');\n    const config = this.srcConfig;\n    if (config.searchPageSelectors.scrollToBottom) {\n      return this.getAllJanUrlsScrollToBottom();\n    } else if (config.searchPageSelectors.nextLink) {\n      return this.getAllJanUrlsPageTransition();\n    } else if (config.searchPageSelectors.onlyCurrentPage) {\n      return this.getAllJanUrlsOnlyCurrentPage();\n    }\n    this.addErr('JANリンク取得方法が定義されていません。');\n    return [];\n  }\n\n  /**\n   * 商品ページをカレントページないからのみ取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsOnlyCurrentPage() {\n    console.log('*** getAllJanUrlsOnlyCurrentPage ***');\n    let page = 1;\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  /**\n   * 商品ページを次ページボタンの遷移で取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsPageTransition() {\n    console.log('*** getAllJanUrlsPageTransition ***');\n    let page = 1;\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    const nextSel = this.srcConfig.searchPageSelectors.nextLink;\n    const links = await this.page.$$eval(productsSel, list => list.map(item => item.href));\n    let nexts;\n    while ((nexts = await this.xselectLink(nextSel)).length > 0) { // →ボタンがある\n      console.log(`PAGE ${++page}`);\n      await nexts[0].click();\n      await this.waitLoaded();\n      links.push(... await this.page.$$eval(productsSel, list => list.map(item => item.href)));\n    }\n    return links;\n  }\n\n  /**\n   * 商品ページをカレントページを下に移動してAjaxで画面を更新し最後までスクロールして取得します。\n   * @return {String[]} URL文字列の配列\n   */\n  async getAllJanUrlsScrollToBottom() {\n    console.log('*** getAllJanUrlsScrollToBottom ***');\n    await this.scrollToBottom(this.page, Constants.viewport.height);\n    const productsSel = this.srcConfig.searchPageSelectors.productsLink;\n    return await this.page.$$eval(productsSel, list => list.map(item => item.href));\n  }\n\n  async scrollToBottom(page, viewportHeight) {\n    const getScrollHeight = () => {\n      return Promise.resolve(document.documentElement.scrollHeight) }\n\n    let scrollHeight = await page.evaluate(getScrollHeight)\n    let currentPosition = 0\n    let scrollNumber = 0\n\n    while (currentPosition < scrollHeight) {\n      scrollNumber += 1\n      const nextPosition = scrollNumber * viewportHeight\n      await page.evaluate(function (scrollTo) {\n        return Promise.resolve(window.scrollTo(0, scrollTo))\n      }, nextPosition)\n      await page.waitForNavigation({waitUntil: 'networkidle2', timeout: 5000})\n                .catch(e => console.log('timeout exceed. proceed to next operation'));\n\n      currentPosition = nextPosition;\n      console.log(`scrollNumber: ${scrollNumber}`)\n      console.log(`currentPosition: ${currentPosition}`)\n\n      // 2\n      scrollHeight = await page.evaluate(getScrollHeight)\n      console.log(`ScrollHeight ${scrollHeight}`)\n    }\n  }\n\n  /**\n   * 商品ページからproductPageSelectorsに定義された情報を取得します。\n   */\n  async getPproductTexts(url) {\n    console.log('*** getPproductTexts ***');\n    await this.page.goto(url, {waitUntil: 'networkidle2'});\n    try {\n      const result =  await reduce(Object.keys(this.srcConfig.productPageSelectors), async (acc, key) => {\n        acc[key] = await this.getPageText(key);\n        return acc;\n      }, {});\n      return result;\n    } catch (e) {\n      console.log(e);\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    }\n  }\n\n  async getImage(jan, dir) {\n    if (!dir || !this.options.image) return;\n    const rows = this.imageInfo.rows || (this.imageInfo.rows = []);\n    const imgs = this.srcConfig.productPageImageSelectors;\n    if (!imgs) throw new Error('Not defined productPageImageSelectors!');\n    const row = {...jan};\n    await forEachSeries(_.toPairs(imgs), async ([key, selector]) => {\n      const imageSrc = await this.page.evaluate((selector) => {\n        const node = document.querySelector(selector);\n        // img.src or a tag\n        return node.src || node.href;\n      }, selector);\n      if (imageSrc) {\n        row[key] = await imageDownload(jan.title, imageSrc, `${dir}/${jan.jan}_${key}`);\n      } else {\n        console.log(`Couldn't get image src ${imageSrc}.`);\n      }\n    });\n    rows.push(row);\n  }\n\n  async getProductTextsByCheerioHttpcli(url) {\n    console.log('*** getProductTextsByCheerioHttpcli ***');\n    return await cheerioClient.fetch(url).then(({err, $, res, body}) => {\n      return Object.keys(this.srcConfig.productPageSelectors).reduce((acc, key) => {\n        const txt = $(this.srcConfig.productPageSelectors[key]).text();\n        if (!acc  || !txt) {\n          console.log('getJanByCheerioHttpcli failed');\n          return undefined;\n        }\n        acc[key] = txt.replace(/[\\s　]+/, ' ').replace(/[\\r\\n]/g, '');\n        return acc;\n      }, {});\n    }).catch(e => {\n      this.addErr('JANがページから取得できませんでした', url);\n      return undefined;\n    });\n  }\n\n  /**\n   * プロダクトページから productPageSelectors に定義されているテキストを取得します。\n   * @param {String} key データ取得キー\n   * @return {String} 取得できたテキスト\n   */\n  async getPageText(key) {\n    const sel = this.srcConfig.productPageSelectors[key];\n    let text = '';\n    try {\n      const targets = await this.xselectLink(sel);\n      if (targets.length > 0) {\n        text = await (await targets[0].getProperty('textContent')).jsonValue();\n      }\n      return text;\n    } finally {\n      if (this.options['debug-pagetext']) {\n        console.log(`getPageText[${key}][${sel}][${text}]`);\n      }\n    }\n  }\n\n  filterJanUrl(links) {\n    return links;\n  }\n}\n\n/** 共通リプレーサ定義 */\nexport const REPLACERS = {\n  toHarfWidth: {\n    pattern: /[！-～]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthAlnum: {\n    pattern: /[Ａ-Ｚａ-ｚ０-９]/g,\n    value: (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);\n    },\n  },\n  toHarfWidthSpace: {\n    pattern: /　+/g,\n    value: ' ',\n  },\n  trim: [ { pattern: /^\\s+/, value: '' },\n          { pattern: /\\s+$/, value: '' } ],\n  toOneSpace: {\n    pattern: /\\s\\s+/g,\n    value: ' ',\n  },\n  toOneLine: {\n    pattern: /\\r?\\n/g,\n    value: ' ',\n  },\n};\n"],"file":"JanSearchBase.js"}