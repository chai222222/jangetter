{"version":3,"sources":["../src/index.js"],"names":["process","on","console","dir","getSiteOpts","knownFlags","names","Object","keys","Site","sort","flag","Set","n2up","reduce","acc","name","c","charAt","has","find","idx","every","Error","add","toLocaleUpperCase","arg","mkDescription","config","top","lastSupportedDate","lastDateStr","map","short","type","description","getSrcConfig","fixedArgs","argv","option","filter","o","test","args","run","targets","length","some","options","help","exit","outputDir","output","errorTxt","error","searchers","words","browser","puppeteer","launch","ignoreHTTPSErrors","headless","page","newPage","frm","log","url","setUserAgent","Constants","userAgent","setViewport","viewport","rcPath","rcfile","rc","undefined","fs","existsSync","JSON","parse","readFileSync","errors","s","search","writeFile","join","err","e","stack","close"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport argv from 'argv';\nimport puppeteer from 'puppeteer';\nimport iconv from 'iconv-lite';\nimport { forEachSeries } from 'p-iteration';\nimport { Parser as Json2csvParser } from 'json2csv';\n\nimport Constants from './constants';\nimport Site from './site';\n\nprocess.on('unhandledRejection', console.dir);\n\n/**\n * サイト名からオプションデータを作成する。\n * 名前の一文字目を大文字にしたものがオプションになるが、すでにある場合は、二文字目以降で使われない文字を使う。\n * @return {Array<Object>} オプションデータ\n */\nfunction getSiteOpts(knownFlags) {\n  const names = Object.keys(Site).sort();\n  const flag = new Set(knownFlags);\n  const n2up = names.reduce((acc, name) => {\n    let c = name.charAt(0);\n    if (flag.has(c)) {\n      c = [ ...name, ...'0123456789'].find((c, idx) => idx > 0\n        && names.every(name => name.charAt(0) !== c)\n        && !flag.has(c));\n      if (!c) throw new Error('オプション設定できません');\n    }\n    flag.add(c);\n    acc[name] = c.toLocaleUpperCase();\n    return acc;\n  }, {})\n  const arg = {};\n  const mkDescription = (name, config) => {\n    const { top, lastSupportedDate }  = config;\n    const lastDateStr = lastSupportedDate ? ` 最終対応日時[${lastSupportedDate}]` : '';\n    // return `検索元[${name}](${top})${lastDateStr}`;\n    return [`検索元[${name}](${top})`, lastDateStr];\n  }\n  return names.map(name => ({\n    name,\n    short: n2up[name],\n    type: 'boolean',\n    description: mkDescription(name, Site[name](arg).getSrcConfig()),\n  }));\n}\n\nconst fixedArgs = [ {\n  name: 'output',\n  short: 'o',\n  type: 'path',\n  description: 'CSVファイル出力先パス',\n}, {\n  name: 'image',\n  short: 'g',\n  type: 'boolean',\n  description: 'フォルダを作成いし画像をダウンロードします',\n}, {\n  name: 'error',\n  short: 'e',\n  type: 'path',\n  description: 'エラー出力先パス',\n}, {\n  name: 'debug-window',\n  type: 'boolean',\n  description: 'デバッグウィンドウ表示を有効にします',\n}, {\n  name: 'debug-url',\n  type: 'boolean',\n  description: 'デバッグURL出力を有効にします',\n}, {\n  name: 'debug-pagetext',\n  type: 'boolean',\n  description: 'デバッグpage textを有効にします',\n}, {\n  name: 'enable-cheerio-httpcli',\n  type: 'boolean',\n  description: '【実験】cheerio-httpcliを有効にして実行します',\n} ];\n\nargv.option([ ...fixedArgs, ...getSiteOpts(fixedArgs.filter(o => o.short && /^[A-Z]$/.test(o.short)).map(o => o.short)) ]);\nconst args = argv.run();\n\nif (args.targets.length < 1 || !Object.keys(Site).some(name => args.options[name])) {\n  argv.help();\n  process.exit(0);\n}\n\nconst outputDir = args.options.output || '.';\nconst errorTxt = args.options.error || 'error.txt';\nconst searchers = [];\n\n(async (words) => {\n  const browser = await puppeteer.launch({\n    ignoreHTTPSErrors: true,\n    headless: !args.options['debug-window'],\n    args: [\n      '--enable-features=NetworkService',\n      '--enable-logging',\n      '--no-sandbox',\n      '--v=1',\n      // `--proxy-server=${config.proxyUrl}`,\n    ],\n  });\n  try {\n    const page = await browser.newPage();\n    await page.on('framenavigated', frm => {\n      if (args.options['debug-url']) {\n        console.log(\"### URL \", frm.url());\n      }\n    });\n    await page.setUserAgent(Constants.userAgent);\n    await page.setViewport(Constants.viewport);\n    // rcファイル読み込み\n    const rcPath = Constants.rcfile;\n    let rc = undefined;\n    if (fs.existsSync(rcPath)) {\n      console.log('load rc file.');\n      rc = JSON.parse(fs.readFileSync(rcPath, 'utf8'));\n    }\n\n    const errors = [];\n    const searchers = Object.keys(Site)\n      .filter(name => args.options[name])\n      .map(name => Site[name]({outputDir, page, errors, rc, options: args.options}));\n\n    await forEachSeries(searchers, async s => await s.search(...words));\n\n    if (errors.length) {\n      console.log(`エラーが発生しました。${errorTxt} へ出力します。`);\n      fs.writeFile(errorTxt, errors.join('\\n'), (err) => {\n        if (err) {\n            throw err;\n        }\n      });\n    }\n  } catch (e) {\n    console.log(e.stack);\n  } finally {\n    console.log('finally');\n    browser.close();\n  }\n})(args.targets);\n"],"file":"index.js"}