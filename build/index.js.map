{"version":3,"sources":["../src/index.js"],"names":["process","on","console","dir","argv","option","name","short","type","description","args","run","targets","length","help","exit","outputCsv","options","output","errorTxt","error","searchers","words","puppeteer","launch","ignoreHTTPSErrors","headless","browser","newPage","page","log","frm","url","setViewport","width","height","errors","itoyokado","push","IyecSearch","aeon","AeonSearch","Array","prototype","concat","s","search","result","apply","fields","json2csvParser","Json2csvParser","csv","parse","sjCsv","iconv","encode","fs","writeFile","err","join","stack","close"],"mappings":"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","file":"index.js","sourcesContent":["import 'babel-polyfill';  // eslint-disable-line import/no-extraneous-dependencies\nimport fs from 'fs';\nimport argv from 'argv';\nimport puppeteer from 'puppeteer';\nimport iconv from 'iconv-lite';\nimport { map } from 'p-iteration';\n\nimport { Parser as Json2csvParser } from 'json2csv';\nimport AeonSearch from './site/AeonSearch';\nimport IyecSearch from './site/IyecSearch';\n\nprocess.on('unhandledRejection', console.dir);\n\nargv.option([ {\n  name: 'output',\n  short: 'o',\n  type: 'path',\n  description: 'output csv file path.',\n}, {\n  name: 'error',\n  short: 'e',\n  type: 'path',\n  description: 'output error file path.',\n}, {\n  name: 'itoyokado',\n  short: 'I',\n  type: 'boolean',\n  description: 'search from ito yoka do',\n}, {\n  name: 'aeon',\n  short: 'A',\n  type: 'boolean',\n  description: 'search from aeon(default)',\n} ]);\nconst args = argv.run();\n\nif (args.targets.length < 1) {\n  argv.help();\n  process.exit(0);\n}\n\nconst outputCsv = args.options.output || 'jan.csv';\nconst errorTxt = args.options.error || 'error.txt';\nconst searchers = [];\n\n(async (words) => {\n  const browser = await puppeteer.launch({\n    ignoreHTTPSErrors: true,\n    headless: true,\n    args: [\n      '--enable-features=NetworkService',\n      '--enable-logging',\n      '--no-sandbox',\n      '--v=1',\n      // `--proxy-server=${config.proxyUrl}`,\n    ],\n  });\n  try {\n    const page = await browser.newPage();\n    await page.on('framenavigated', frm => {\n      console.log(\"### URL \", frm.url());\n    });\n    await page.setViewport({ width: 1600, height: 1200 });\n\n    const errors = [];\n    const searchers = [];\n\n    if (args.options.itoyokado) searchers.push(new IyecSearch(page, errors));\n    if (args.options.aeon)      searchers.push(new AeonSearch(page, errors));\n    if (searchers.length === 0) searchers.push(new AeonSearch(page, errors));\n\n    const result = Array.prototype.concat.apply([],\n      await map(searchers, async s => await s.search(...words)));\n\n    // 結果をCSV(ShiftJIS)にして保存\n    const fields = ['jan', 'title', 'category'];\n    const json2csvParser = new Json2csvParser({fields});\n    const csv = json2csvParser.parse(result);\n    const sjCsv = iconv.encode(csv, \"Shift_JIS\");\n\n    fs.writeFile(outputCsv, sjCsv, (err) => {\n      if (err) {\n          throw err;\n      }\n    });\n    console.log(`Output done. [${outputCsv}]`);\n    if (errors.length) {\n      console.log(`エラーが発生しました。${errorTxt} へ出力します。`);\n      fs.writeFile(errorTxt, errors.join('\\n'), (err) => {\n        if (err) {\n            throw err;\n        }\n      });\n    }\n  } catch (e) {\n    console.log(e.stack);\n  } finally {\n    console.log('finally');\n    browser.close();\n  }\n})(args.targets);\n"]}