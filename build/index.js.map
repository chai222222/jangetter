{"version":3,"sources":["../src/index.js"],"names":["process","on","console","dir","getSiteOpts","knownFlags","names","Object","keys","Site","sort","flag","Set","n2up","reduce","acc","name","c","charAt","has","find","idx","every","nm","Error","add","toLocaleUpperCase","arg","mkDescription","config","top","lastSupportedDate","lastDateStr","map","short","type","description","getSrcConfig","fixedArgs","argv","option","filter","o","test","args","run","targets","length","some","options","help","exit","outputDir","output","errorTxt","error","words","browser","puppeteer","launch","ignoreHTTPSErrors","headless","context","createIncognitoBrowserContext","page","newPage","frm","log","url","setUserAgent","Constants","userAgent","setViewport","viewport","rcPath","rcfile","rc","undefined","fs","existsSync","JSON","parse","readFileSync","errors","searchers","s","search","writeFile","join","err","e","stack","close"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport argv from 'argv';\nimport puppeteer from 'puppeteer';\nimport iconv from 'iconv-lite';\nimport { forEachSeries } from 'p-iteration';\nimport { Parser as Json2csvParser } from 'json2csv';\n\nimport Constants from './constants';\nimport Site from './site';\n\nprocess.on('unhandledRejection', console.dir);\n\n/**\n * サイト名からオプションデータを作成する。\n * 名前の一文字目を大文字にしたものがオプションになるが、すでにある場合は、二文字目以降で使われない文字を使う。\n * @return {Array<Object>} オプションデータ\n */\nfunction getSiteOpts(knownFlags) {\n  const names = Object.keys(Site).sort();\n  const flag = new Set(knownFlags);\n  const n2up = names.reduce((acc, name) => {\n    let c = name.charAt(0);\n    if (flag.has(c)) {\n      c = [...name, ...'0123456789'].find((c, idx) => idx > 0\n        && names.every(nm => nm.charAt(0) !== c)\n        && !flag.has(c));\n      if (!c) throw new Error('オプション設定できません');\n    }\n    flag.add(c);\n    acc[name] = c.toLocaleUpperCase();\n    return acc;\n  }, {});\n  const arg = {};\n  const mkDescription = (name, config) => {\n    const { top, lastSupportedDate } = config;\n    const lastDateStr = lastSupportedDate ? ` 最終対応日時[${lastSupportedDate}]` : '';\n    // return `検索元[${name}](${top})${lastDateStr}`;\n    return [`検索元[${name}](${top})`, lastDateStr];\n  };\n  return names.map((name) => ({\n    name,\n    short: n2up[name],\n    type: 'boolean',\n    description: mkDescription(name, Site[name](arg).getSrcConfig()),\n  }));\n}\n\nconst fixedArgs = [{\n  name: 'output',\n  short: 'o',\n  type: 'path',\n  description: 'CSVファイル出力先パス',\n}, {\n  name: 'image',\n  short: 'g',\n  type: 'boolean',\n  description: 'フォルダを作成いし画像をダウンロードします',\n}, {\n  name: 'error',\n  short: 'e',\n  type: 'path',\n  description: 'エラー出力先パス',\n}, {\n  name: 'debug-window',\n  type: 'boolean',\n  description: 'デバッグウィンドウ表示を有効にします',\n}, {\n  name: 'debug-url',\n  type: 'boolean',\n  description: 'デバッグURL出力を有効にします',\n}, {\n  name: 'debug-pagetext',\n  type: 'boolean',\n  description: 'デバッグpage textを有効にします',\n}, {\n  name: 'enable-cheerio-httpcli',\n  type: 'boolean',\n  description: '【実験】cheerio-httpcliを有効にして実行します',\n}];\n\nargv.option([...fixedArgs, ...getSiteOpts(fixedArgs.filter(o => o.short && /^[A-Z]$/.test(o.short)).map(o => o.short))]);\nconst args = argv.run();\n\nif (args.targets.length < 1 || !Object.keys(Site).some(nm => args.options[nm])) {\n  argv.help();\n  process.exit(0);\n}\n\nconst outputDir = args.options.output || '.';\nconst errorTxt = args.options.error || 'error.txt';\n\n(async (words) => {\n  const browser = await puppeteer.launch({\n    ignoreHTTPSErrors: true,\n    headless: !args.options['debug-window'],\n    args: [\n      '--enable-features=NetworkService',\n      '--enable-logging',\n      '--no-sandbox',\n      '--v=1',\n      // `--proxy-server=${config.proxyUrl}`,\n    ],\n  });\n  try {\n    const context = await browser.createIncognitoBrowserContext();\n    const page = await context.newPage();\n    await page.on('framenavigated', frm => {\n      if (args.options['debug-url']) {\n        console.log(\"### URL \", frm.url());\n      }\n    });\n    await page.setUserAgent(Constants.userAgent);\n    await page.setViewport(Constants.viewport);\n    // rcファイル読み込み\n    const rcPath = Constants.rcfile;\n    let rc = undefined;\n    if (fs.existsSync(rcPath)) {\n      console.log('load rc file.');\n      rc = JSON.parse(fs.readFileSync(rcPath, 'utf8'));\n    }\n\n    const errors = [];\n    const searchers = Object.keys(Site)\n      .filter(nm => args.options[nm])\n      .map(nm => Site[nm]({ outputDir, page, errors, rc, options: args.options }));\n\n    await forEachSeries(searchers, async s => await s.search(...words));\n\n    if (errors.length) {\n      console.log(`エラーが発生しました。${errorTxt} へ出力します。`);\n      fs.writeFile(errorTxt, `${errors.join('\\n')}\\n`, (err) => {\n        if (err) {\n            throw err;\n        }\n      });\n    }\n  } catch (e) {\n    console.log(e.stack);\n  } finally {\n    console.log('finally');\n    browser.close();\n  }\n})(args.targets);\n"],"file":"index.js"}