{"version":3,"sources":["../src/index.js"],"names":["process","on","console","dir","getSiteOpts","knownFlags","names","Object","keys","Site","sort","flag","Set","n2up","reduce","acc","name","c","charAt","has","find","cc","idx","every","nm","Error","add","toLocaleUpperCase","arg","mkDescription","config","top","lastSupportedDate","lastDateStr","map","short","type","description","getSrcConfig","loadRc","rcPath","Constants","rcfile","fs","existsSync","log","JSON","parse","readFileSync","fixedArgs","argv","option","filter","o","test","args","run","outputDir","options","output","errorTxt","error","rc","errors","createSeachers","filterFunc","page","site","siteKey","info","searchers","length","cols","toLine","searcher","srcConfig","join","forEach","Replacer","showReplacers","outSite","stringify","toSpecialString","replacer","repDefs","exit","targets","some","help","words","browser","puppeteer","launch","ignoreHTTPSErrors","headless","context","createIncognitoBrowserContext","newPage","frm","url","setUserAgent","userAgent","setViewport","viewport","s","search","writeFile","err","e","stack","close"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport fs from 'fs';\nimport argv from 'argv';\nimport puppeteer from 'puppeteer';\nimport { forEachSeries } from 'p-iteration';\n\nimport Constants from './constants';\nimport Site from './site';\nimport Replacer, { REPLACERS } from './util/Replacer';\n\nprocess.on('unhandledRejection', console.dir);\n\n/**\n * サイト名からオプションデータを作成する。\n * 名前の一文字目を大文字にしたものがオプションになるが、すでにある場合は、二文字目以降で使われない文字を使う。\n * @param {Array<String>} knownFlags 使用済みのショートオプション\n * @return {Array<Object>} オプションデータ\n */\nfunction getSiteOpts(knownFlags) {\n  const names = Object.keys(Site).sort();\n  const flag = new Set(knownFlags);\n  const n2up = names.reduce((acc, name) => {\n    let c = name.charAt(0);\n    if (flag.has(c)) {\n      c = [...name, ...'0123456789'].find((cc, idx) => idx > 0\n        && names.every(nm => nm.charAt(0) !== cc)\n        && !flag.has(cc));\n      if (!c) throw new Error('オプション設定できません');\n    }\n    flag.add(c);\n    acc[name] = c.toLocaleUpperCase();\n    return acc;\n  }, {});\n  const arg = {};\n  const mkDescription = (name, config) => {\n    const { top, lastSupportedDate } = config;\n    const lastDateStr = lastSupportedDate ? ` 最終対応日時[${lastSupportedDate}]` : '';\n    // return `検索元[${name}](${top})${lastDateStr}`;\n    return [`検索元[${name}](${top})`, lastDateStr];\n  };\n  return names.map((name) => ({\n    name,\n    short: n2up[name],\n    type: 'boolean',\n    description: mkDescription(name, Site[name](arg).getSrcConfig()),\n  }));\n}\n\n/**\n * .jangetterrcファイルを読み込みます。\n * 存在しない場合には何も行いません。\n * @return {Object} rcファイルのJSON\n */\nfunction loadRc() {\n  // rcファイル読み込み\n  const rcPath = Constants.rcfile;\n  if (fs.existsSync(rcPath)) {\n    console.log('load rc file.');\n    return JSON.parse(fs.readFileSync(rcPath, 'utf8'));\n  }\n  return {};\n}\n\nconst fixedArgs = [{\n  name: 'output',\n  short: 'o',\n  type: 'path',\n  description: 'CSVファイル出力先パス',\n}, {\n  name: 'image',\n  short: 'g',\n  type: 'boolean',\n  description: 'フォルダを作成いし画像をダウンロードします',\n}, {\n  name: 'error',\n  short: 'e',\n  type: 'path',\n  description: 'エラー出力先パス',\n}, {\n  name: 'debug-window',\n  type: 'boolean',\n  description: 'デバッグウィンドウ表示を有効にします',\n}, {\n  name: 'debug-url',\n  type: 'boolean',\n  description: 'デバッグURL出力を有効にします',\n}, {\n  name: 'debug-pagetext',\n  type: 'boolean',\n  description: 'デバッグpage textを有効にします',\n}, {\n  name: 'enable-cheerio-httpcli',\n  type: 'boolean',\n  description: '【実験】cheerio-httpcliを有効にして実行します(非推奨：puppeteerでの取得と完全互換がないため)',\n}, {\n  name: 'info',\n  type: 'boolean',\n  description: '情報表示',\n}];\n\nargv.option([...fixedArgs, ...getSiteOpts(fixedArgs.filter(o => o.short && /^[A-Z]$/.test(o.short)).map(o => o.short))]);\n// argv#run にて、optionsオブジェクトにオプション、targetsにパラメータが設定される\nconst args = argv.run();\n\nconst outputDir = args.options.output || '.';\nconst errorTxt = args.options.error || 'error.txt';\nconst rc = loadRc();\nconst errors = [];\n\n/**\n * サイト検索用クラスの作成を行います。\n * @param {Function} filterFunc Siteオブジェクトのキーをフィルタする関数です。\n * @param {*} page puppeteerのページオブジェクト（実行しない場合には不要）。\n * @returns {Array<Site>} 対象のSite配列\n */\nfunction createSeachers(filterFunc, page) {\n  return Object.keys(Site)\n    .filter(filterFunc)\n    .map((site) => Site[site]({ siteKey: site, outputDir, page, errors, rc, options: args.options }));\n}\n\nif (args.options.info) {\n  let searchers = createSeachers((site) => args.options[site], null);\n  if (!searchers.length) {\n    // 対象オプションがない場合は全体の name, siteOpt, top を出力(mdでの日本語桁揃えがうまくいかないためcsv)\n    searchers = createSeachers(() => true, null);\n    const cols = 'name,siteOpt,top';\n    const toLine = (searcher) => [searcher.srcConfig.name, searcher.siteKey, searcher.srcConfig.top].join(',');\n    console.log(cols);\n    searchers.forEach(searcher => console.log(toLine(searcher)));\n    Replacer.showReplacers();\n  } else {\n    const outSite = (site, info) => {\n      console.log(`**** ${site.siteKey} ****`)\n      console.log(JSON.stringify(Replacer.toSpecialString(info), '', 2));\n    }\n    // 対象オプションがある場合、対象設定を出力\n    searchers.forEach(site => outSite(site, site.srcConfig));\n    searchers.forEach(site => outSite(site, site.replacer.repDefs));\n  }\n  process.exit(0);\n}\nif (args.targets.length < 1 || !Object.keys(Site).some(nm => args.options[nm])) {\n  argv.help();\n  process.exit(0);\n}\n\n(async (words) => {\n  const browser = await puppeteer.launch({\n    ignoreHTTPSErrors: true,\n    headless: !args.options['debug-window'],\n    args: [\n      '--enable-features=NetworkService',\n      '--enable-logging',\n      '--no-sandbox',\n      '--v=1',\n      // `--proxy-server=${config.proxyUrl}`,\n    ],\n  });\n  try {\n    const context = await browser.createIncognitoBrowserContext();\n    const page = await context.newPage();\n    await page.on('framenavigated', frm => {\n      if (args.options['debug-url']) {\n        console.log(\"### URL \", frm.url());\n      }\n    });\n    await page.setUserAgent(Constants.userAgent);\n    await page.setViewport(Constants.viewport);\n\n    const searchers = createSeachers((site) => args.options[site], page);\n\n    await forEachSeries(searchers, async s => await s.search(...words));\n\n    if (errors.length) {\n      console.log(`エラーが発生しました。${errorTxt} へ出力します。`);\n      fs.writeFile(errorTxt, `${errors.join('\\n')}\\n`, (err) => {\n        if (err) {\n          throw err;\n        }\n      });\n    }\n  } catch (e) {\n    console.log(e.stack);\n  } finally {\n    browser.close();\n  }\n})(args.targets);\n"],"file":"index.js"}